@page "/alerts/{Id}"
@inject IAlertRepository AlertRepository
@inject ICustomerRepository CustomerRepository
@inject IResourceRepository ResourceRepository
@inject IFunctionAppService FunctionAppService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject ILogger<AlertDetail> Logger

<PageTitle>Alert</PageTitle>

@if (loading)
{
    <div class="text-center py-5">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" Class="mb-2" />
        <div class="text-muted">Loading alert...</div>
    </div>
}
else if (alert is null)
{
    <MudAlert Severity="Severity.Warning">Alert was not found.</MudAlert>
}
else
{
    <MudPaper Class="pa-4 mb-3">
        <div class="d-flex align-items-center gap-3">
            <MudIcon Icon="@GetSeverityIcon(alert.Severity)" Color="@GetSeverityColor(alert.Severity)" Size="Size.Large" />
            <MudText Typo="Typo.h5" Class="mb-0">@(!string.IsNullOrWhiteSpace(alert.Title) ? alert.Title : "Alert")</MudText>
        </div>
    </MudPaper>

    <MudPaper Class="pa-4 mb-3">
        <MudText Typo="Typo.h6" Class="mb-3">Details</MudText>
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudText Color="Color.Secondary" Typo="Typo.caption">Customer</MudText>
                <MudText>@customerName</MudText>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudText Color="Color.Secondary" Typo="Typo.caption">Type</MudText>
                <MudText>@alert.AlertType</MudText>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudText Color="Color.Secondary" Typo="Typo.caption">Severity</MudText>
                <MudText>@alert.Severity</MudText>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudText Color="Color.Secondary" Typo="Typo.caption">Status</MudText>
                <MudText>@alert.Status</MudText>
            </MudItem>
        </MudGrid>
        <MudDivider Class="my-3" />

        <MudText Color="Color.Secondary" Typo="Typo.caption">Description</MudText>
        <MudText>@(string.IsNullOrWhiteSpace(alert.Description) ? "No description provided." : alert.Description)</MudText>
    </MudPaper>

    <MudPaper Class="pa-4 mb-3">
        <MudText Typo="Typo.h6" Class="mb-3">Related Resource</MudText>
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Primary"
                   Disabled="@string.IsNullOrWhiteSpace(resourceDocumentId)"
                   Href="@($"/resources/{resourceDocumentId}")"
                   StartIcon="@Icons.Material.Filled.Memory">
            @resourceName
        </MudButton>
    </MudPaper>

    @if (alert.Status != AlertStatus.Failed)
    {
        <MudPaper Class="pa-4 mb-3">
            <MudText Typo="Typo.h6" Class="mb-3">Actions</MudText>
            <div class="d-flex gap-3 flex-wrap">
                @if (alert.Status == AlertStatus.Resolved)
                {
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Disabled="@isUpdatingAlert"
                               OnClick="ReopenAlertAsync"
                               StartIcon="@Icons.Material.Filled.Refresh">
                        Reopen
                    </MudButton>
                }
                else
                {
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Warning"
                               Disabled="@(isUpdatingAlert || alert.Status == AlertStatus.Accepted)"
                               OnClick="AcceptAlertAsync"
                               StartIcon="@Icons.Material.Filled.CheckCircle">
                        Accept
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Success"
                               Disabled="@isUpdatingAlert"
                               OnClick="ResolveAlertAsync"
                               StartIcon="@Icons.Material.Filled.Done">
                        Resolve
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Error"
                               Disabled="@isUpdatingAlert"
                               OnClick="EscalateAlertAsync"
                               StartIcon="@Icons.Material.Filled.NotificationImportant">
                        Escalate to backup
                    </MudButton>
                }
            </div>
        </MudPaper>
    }

    <MudPaper Class="pa-4 mb-3">
        <MudText Typo="Typo.h6" Class="mb-3">Timeline</MudText>
        @if (Timeline.Any())
        {
            <MudTimeline TimelinePosition="TimelinePosition.Start">
                @foreach (var entry in Timeline)
                {
                    <MudTimelineItem Color="@GetTimelineColor(entry)" Size="Size.Small">
                        <ItemContent>
                            <MudText Typo="Typo.body2">@FormatTimelineMessage(entry)</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@entry.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</MudText>
                        </ItemContent>
                    </MudTimelineItem>
                }
            </MudTimeline>
        }
        else
        {
            <MudText Color="Color.Secondary">No events yet.</MudText>
        }
    </MudPaper>

}

@code {
    [Parameter] public string Id { get; set; } = string.Empty;

    private Alert? alert;
    private string customerName = "-";
    private string resourceName = "-";
    private string resourceType = "-";
    private string resourceDocumentId = string.Empty;
    private bool loading = true;
    private bool hasLoaded;
    private bool isUpdatingAlert;
    private string currentUser = "unknown";

    private IEnumerable<AlertChange> Timeline =>
        (alert?.Changes ?? Enumerable.Empty<AlertChange>()).OrderByDescending(c => c.CreatedAt);

    protected override async Task OnInitializedAsync()
    {
        await SetCurrentUserAsync();
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        if (hasLoaded)
        {
            return;
        }

        hasLoaded = true;
        loading = true;

        try
        {
            alert = await AlertRepository.GetAsync(Id);
            if (alert is null)
            {
                return;
            }

            var customer = await CustomerRepository.GetAsync(alert.CustomerId);
            customerName = customer?.Name ?? alert.CustomerId;

            if (!string.IsNullOrWhiteSpace(alert.ResourceId))
            {
                var resource = await ResourceRepository.GetByResourceIdAsync(alert.CustomerId, alert.ResourceId);
                if (resource is not null)
                {
                    resourceName = resource.Name;
                    resourceDocumentId = resource.Id;
                    resourceType = string.IsNullOrWhiteSpace(resource.ResourceType) ? alert.ResourceType : resource.ResourceType;
                }
                else
                {
                    resourceName = alert.ResourceId;
                    resourceType = alert.ResourceType;
                }
            }
            else
            {
                resourceName = "(resource unknown)";
                resourceType = alert.ResourceType;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load alert {AlertId}", Id);
            Snackbar.Add($"Failed to load alert: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task AcceptAlertAsync()
    {
        if (alert is null || isUpdatingAlert)
        {
            return;
        }

        isUpdatingAlert = true;
        try
        {
            alert.MarkStatus(AlertStatus.Accepted);
            alert.Changes ??= new();
            alert.Changes.Add(new AlertChange
            {
                Id = Guid.NewGuid().ToString(),
                User = currentUser,
                Comment = $"{currentUser} accepted this alert",
                NewStatus = AlertStatus.Accepted,
                CreatedAt = DateTime.UtcNow
            });

            alert = await AlertRepository.UpdateAsync(alert.Id, alert);
            Snackbar.Add("Alert accepted", Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to accept alert {AlertId}", alert?.Id ?? Id);
            Snackbar.Add($"Failed to accept alert: {ex.Message}", Severity.Error);
        }
        finally
        {
            isUpdatingAlert = false;
            StateHasChanged();
        }
    }

    private async Task ResolveAlertAsync()
    {
        if (alert is null || isUpdatingAlert)
        {
            return;
        }

        isUpdatingAlert = true;
        try
        {
            alert.MarkStatus(AlertStatus.Resolved);
            alert.Changes ??= new();
            alert.Changes.Add(new AlertChange
            {
                Id = Guid.NewGuid().ToString(),
                User = currentUser,
                Comment = $"{currentUser} resolved this alert",
                NewStatus = AlertStatus.Resolved,
                CreatedAt = DateTime.UtcNow
            });

            alert = await AlertRepository.UpdateAsync(alert.Id, alert);
            Snackbar.Add("Alert resolved", Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to resolve alert {AlertId}", alert?.Id ?? Id);
            Snackbar.Add($"Failed to resolve alert: {ex.Message}", Severity.Error);
        }
        finally
        {
            isUpdatingAlert = false;
            StateHasChanged();
        }
    }

    private async Task ReopenAlertAsync()
    {
        if (alert is null || isUpdatingAlert)
        {
            return;
        }

        isUpdatingAlert = true;
        try
        {
            alert.MarkStatus(AlertStatus.Pending);
            alert.ResolvedAt = null;
            alert.Changes ??= new();
            alert.Changes.Add(new AlertChange
            {
                Id = Guid.NewGuid().ToString(),
                User = currentUser,
                Comment = $"{currentUser} reopened this alert",
                NewStatus = AlertStatus.Pending,
                PreviousStatus = AlertStatus.Resolved,
                CreatedAt = DateTime.UtcNow
            });

            alert = await AlertRepository.UpdateAsync(alert.Id, alert);
            Snackbar.Add("Alert reopened", Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to reopen alert {AlertId}", alert?.Id ?? Id);
            Snackbar.Add($"Failed to reopen alert: {ex.Message}", Severity.Error);
        }
        finally
        {
            isUpdatingAlert = false;
            StateHasChanged();
        }
    }

    private async Task EscalateAlertAsync()
    {
        if (alert is null || isUpdatingAlert)
        {
            return;
        }

        isUpdatingAlert = true;
        try
        {
            var success = await FunctionAppService.EscalateAlertAsync(alert.Id);
            if (success)
            {
                // Reload alert to get updated state from the function
                alert = await AlertRepository.GetAsync(alert.Id);
                Snackbar.Add("Alert escalated to backup", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to escalate alert - check Function App configuration", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to escalate alert {AlertId}", alert?.Id ?? Id);
            Snackbar.Add($"Failed to escalate alert: {ex.Message}", Severity.Error);
        }
        finally
        {
            isUpdatingAlert = false;
            StateHasChanged();
        }
    }

    private async Task SetCurrentUserAsync()
    {
        try
        {
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            var name = state.User?.Identity?.Name;
            if (!string.IsNullOrWhiteSpace(name))
            {
                currentUser = name!;
            }
        }
        catch
        {
            currentUser = "unknown";
        }
    }

    private string FormatTimelineMessage(AlertChange entry)
    {
        if (!string.IsNullOrWhiteSpace(entry.Comment))
        {
            return entry.Comment;
        }

        return entry.NewStatus switch
        {
            AlertStatus.Accepted => $"{entry.User} accepted this alert",
            AlertStatus.Resolved => $"{entry.User} resolved this alert",
            AlertStatus.Escalated => $"{entry.User} escalated this alert",
            AlertStatus.Pending => "Alert pending",
            AlertStatus.Failed => "Alert processing failed",
            _ => $"Status changed to {entry.NewStatus}"
        };
    }

    private Color GetTimelineColor(AlertChange entry) => entry.NewStatus switch
    {
        AlertStatus.Accepted => Color.Warning,
        AlertStatus.Resolved => Color.Success,
        AlertStatus.Escalated => Color.Error,
        AlertStatus.Failed => Color.Error,
        _ => Color.Primary
    };

    private static string GetSeverityIcon(AlertSeverity severity) => severity switch
    {
        AlertSeverity.Critical => Icons.Material.Filled.Error,
        AlertSeverity.High => Icons.Material.Filled.Warning,
        AlertSeverity.Medium => Icons.Material.Filled.Info,
        AlertSeverity.Low => Icons.Material.Filled.Flag,
        AlertSeverity.Info => Icons.Material.Outlined.Info,
        _ => Icons.Material.Filled.Notifications
    };

    private static Color GetSeverityColor(AlertSeverity severity) => severity switch
    {
        AlertSeverity.Critical => Color.Error,
        AlertSeverity.High => Color.Warning,
        AlertSeverity.Medium => Color.Info,
        AlertSeverity.Low => Color.Success,
        AlertSeverity.Info => Color.Default,
        _ => Color.Default
    };
}
