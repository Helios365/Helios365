@inject IResourceService ResourceService
@inject ISnackbar Snackbar
@inject ILogger<VmDetails> Logger

@if (Resource is null)
{
    <MudAlert Severity="Severity.Info">No VM data.</MudAlert>
}
else
{
    <MudPaper Class="pa-4 mb-3">
        <MudText Typo="Typo.h6" Class="mb-3">Virtual Machine</MudText>
        <MudText Color="Color.Secondary" Typo="Typo.caption">Size</MudText>
        <MudText>@GetMetadata("vmSize")</MudText>
        <MudText Color="Color.Secondary" Typo="Typo.caption" Class="mt-2">OS</MudText>
        <MudText>@GetMetadata("osType")</MudText>
        <MudStack Row="true" Spacing="2" Class="mt-2">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="@IsDisabled"
                       OnClick="RestartAsync">
                Restart
            </MudButton>
        </MudStack>
    </MudPaper>
}

@code {
    [Parameter] public Resource? Resource { get; set; }
    [Parameter] public ServicePrincipal? ServicePrincipal { get; set; }
    [Parameter] public bool Disabled { get; set; }

    private bool busy;
    private bool IsDisabled => Disabled || busy || ServicePrincipal is null;

    private string GetMetadata(string key)
    {
        if (Resource?.Metadata is null)
        {
            return "-";
        }

        foreach (var kvp in Resource.Metadata)
        {
            if (string.Equals(kvp.Key, key, StringComparison.OrdinalIgnoreCase))
            {
                return string.IsNullOrWhiteSpace(kvp.Value) ? "-" : kvp.Value;
            }
        }

        return "-";
    }

    private async Task RestartAsync()
    {
        if (Resource is null || ServicePrincipal is null)
        {
            Snackbar.Add("Missing resource or service principal for restart.", Severity.Error);
            return;
        }

        busy = true;
        try
        {
            await ResourceService.RestartAsync(ServicePrincipal, Resource, new RestartAction { WaitAfterSeconds = 10 });
            Snackbar.Add("Virtual machine restart initiated.", Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to restart virtual machine {ResourceId}", Resource.Id);
            Snackbar.Add($"Restart failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            busy = false;
        }
    }
}
