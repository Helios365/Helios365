@page "/customers/{id}"
@inject ICustomerRepository CustomerRepository
@inject IServicePrincipalRepository ServicePrincipalRepository
@inject ISecretRepository SecretRepository
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ILogger<CustomerDetails> Logger
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Customer Details</PageTitle>

<MudPaper Class="pa-4 mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2>@customer?.Name</h2>
        </div>
        @if (customer is not null)
        {
            <MudTooltip Text="Copy Customer ID">
                <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Color="Color.Default" OnClick="CopyCustomerId" />
            </MudTooltip>
        }
    </div>
    @if (customer is not null)
    {
        <MudText Class="mb-1"><strong>Status:</strong> @(customer.Active ? "Active" : "Inactive")</MudText>
        <MudText Class="mb-1"><strong>Escalation:</strong> @customer.EscalationTimeoutMinutes min</MudText>
        <MudText Class="mb-1"><strong>Emails:</strong> @string.Join(", ", customer.NotificationEmails ?? Enumerable.Empty<string>())</MudText>
        <MudText Class="text-muted"><small>Updated @customer.UpdatedAt.ToString("yyyy-MM-dd HH:mm")</small></MudText>
    }
    else
    {
        <MudText Color="Color.Error">Customer not found.</MudText>
    }
</MudPaper>

<MudPaper Class="pa-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <MudText Typo="Typo.h5">Service Principals</MudText>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Disabled="@(customer is null)" OnClick="CreateServicePrincipal">Add Service Principal</MudButton>
    </div>

    <MudTable T="ServicePrincipal" Items="@servicePrincipals" Dense="true" Hover="true">
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Tenant</MudTh>
            <MudTh>Cloud</MudTh>
            <MudTh>Active</MudTh>
            <MudTh>Updated</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">@context.Name</MudTd>
            <MudTd DataLabel="Tenant">@context.TenantId</MudTd>
            <MudTd DataLabel="Cloud">@context.CloudEnvironment</MudTd>
            <MudTd DataLabel="Active">@(context.Active ? "Yes" : "No")</MudTd>
            <MudTd DataLabel="Updated">@context.UpdatedAt.ToString("yyyy-MM-dd HH:mm")</MudTd>
            <MudTd Class="text-end">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="() => EditServicePrincipal(context)" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => ConfirmDelete(context)" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No service principals found.</MudText>
        </NoRecordsContent>
    </MudTable>
</MudPaper>

@code {
    [Parameter] public string? id { get; set; }

    private Customer? customer;
    private List<ServicePrincipal> servicePrincipals = new();

    protected override async Task OnParametersSetAsync()
    {
        await LoadCustomerAndPrincipals();
    }

    private async Task LoadCustomerAndPrincipals()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(id))
            {
                customer = null;
                servicePrincipals.Clear();
                return;
            }

            customer = await CustomerRepository.GetAsync(id);
            if (customer is null)
            {
                servicePrincipals.Clear();
                return;
            }

            servicePrincipals = (await ServicePrincipalRepository.ListByCustomerAsync(customer.Id, limit: 1000)).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load customer or service principals");
            Snackbar.Add($"Failed to load data: {ex.Message}", Severity.Error);
        }
    }

    private void BackToCustomers() => Nav.NavigateTo("/customers");

    private async Task CopyCustomerId()
    {
        if (customer is null) return;
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", customer.Id);
            Snackbar.Add("Customer ID copied", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Failed to copy Customer ID", Severity.Error);
        }
    }

    private async Task CreateServicePrincipal()
    {
        if (customer is null) return;
        var sp = new ServicePrincipal { CustomerId = customer.Id };
        var parameters = new DialogParameters
        {
            [nameof(Shared.ServicePrincipalEditDialog.Model)] = sp,
            [nameof(Shared.ServicePrincipalEditDialog.IsEdit)] = false,
            [nameof(Shared.ServicePrincipalEditDialog.LockCustomerId)] = true
        };
        var options = new DialogOptions { CloseButton = false, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<Shared.ServicePrincipalEditDialog>("Add Service Principal", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled && result.Data is Helios365.Web.Models.ServicePrincipalEditResult createResult)
        {
            try
            {
                var created = createResult.Principal;
                created.CustomerId = customer.Id;
                created.CreatedAt = DateTime.UtcNow;
                created.UpdatedAt = DateTime.UtcNow;

                if (!string.IsNullOrWhiteSpace(createResult.NewClientSecret))
                {
                    var reference = await SecretRepository.SetServicePrincipalSecretAsync(created, createResult.NewClientSecret!);
                    created.ClientSecretKeyVaultReference = reference;
                }
                else if (string.IsNullOrWhiteSpace(created.ClientSecretKeyVaultReference))
                {
                    throw new InvalidOperationException("Client secret is required for new service principals");
                }

                await ServicePrincipalRepository.CreateAsync(created);
                Snackbar.Add($"Service Principal '{created.Name}' created", Severity.Success);
                await LoadCustomerAndPrincipals();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, message:"Failed to create service principal");
                Snackbar.Add(message: $"Failed to create service principal: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task EditServicePrincipal(ServicePrincipal sp)
    {
        var parameters = new DialogParameters
        {
            [nameof(Shared.ServicePrincipalEditDialog.Model)] = sp,
            [nameof(Shared.ServicePrincipalEditDialog.IsEdit)] = true,
            [nameof(Shared.ServicePrincipalEditDialog.LockCustomerId)] = true
        };
        var options = new DialogOptions { CloseButton = false, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<Shared.ServicePrincipalEditDialog>($"Edit {sp.Name}", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled && result.Data is Helios365.Web.Models.ServicePrincipalEditResult editResult)
        {
            try
            {
                var edited = editResult.Principal;
                edited.CustomerId = customer?.Id ?? edited.CustomerId;
                if (!string.IsNullOrWhiteSpace(editResult.NewClientSecret))
                {
                    var reference = await SecretRepository.SetServicePrincipalSecretAsync(edited, editResult.NewClientSecret!);
                    edited.ClientSecretKeyVaultReference = reference;
                }
                await ServicePrincipalRepository.UpdateAsync(sp.Id, edited);
                Snackbar.Add($"Service Principal '{edited.Name}' updated", Severity.Success);
                await LoadCustomerAndPrincipals();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to update service principal");
                Snackbar.Add($"Failed to update service principal: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ConfirmDelete(ServicePrincipal sp)
    {
        var confirmed = await DialogService.ShowMessageBox(
            title: "Delete Service Principal",
            markupMessage: (MarkupString)$"Are you sure you want to delete '<strong>{sp.Name}</strong>'?",
            yesText: "Delete",
            cancelText: "Cancel",
            options: new DialogOptions { MaxWidth = MaxWidth.Small });

        if (confirmed == true)
        {
            try
            {
                var ok = await ServicePrincipalRepository.DeleteAsync(sp.Id);
                if (ok)
                {
                    Snackbar.Add($"Service Principal '{sp.Name}' deleted", Severity.Success);
                    await LoadCustomerAndPrincipals();
                }
                else
                {
                    Snackbar.Add("Service principal not found", Severity.Warning);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to delete service principal");
                Snackbar.Add($"Failed to delete service principal: {ex.Message}", Severity.Error);
            }
        }
    }

    private static string Short(string? value, int max = 10)
        => string.IsNullOrEmpty(value) ? "-" : (value!.Length > max ? value.Substring(0, max) + "..." : value);
}
