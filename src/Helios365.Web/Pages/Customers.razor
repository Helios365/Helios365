@page "/customers"
@inject ICustomerRepository CustomerRepository
@inject NavigationManager Nav
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ILogger<Customers> Logger

<PageTitle>Customers</PageTitle>

<h1 class="mb-3">Customers</h1>

<MudPaper Class="pa-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <MudTextField T="string" @bind-Value="search" Placeholder="Search customers..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Class="me-2" Immediate="true" />
        <MudButton Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" OnClick="CreateCustomer">Add Customer</MudButton>
    </div>

    <MudGrid Spacing="2">
        @foreach (var c in FilteredCustomers)
        {
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudCard Class="mb-3">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <div class="d-flex align-items-center">
                                <MudIcon Icon="@Icons.Material.Filled.Business" Color="Color.Primary" Class="me-2" />
                                <MudText Typo="Typo.h6">@((c.Name ?? "-"))</MudText>
                            </div>
                        </CardHeaderContent>
                    </MudCardHeader>
                        <MudCardContent>
                            <MudText Class="mb-1"><strong>Status:</strong> @(c.Active ? "Active" : "Inactive")</MudText>
                            <MudText Class="mb-1"><strong>Escalation:</strong> @c.EscalationTimeoutMinutes min</MudText>
                            <MudText Class="mb-1"><strong>Emails:</strong> @((c.NotificationEmails?.Count) ?? 0)</MudText>
                            <MudText Class="text-muted"><small>Updated @c.UpdatedAt.ToString("yyyy-MM-dd HH:mm")</small></MudText>
                    </MudCardContent>
                    <MudCardActions Class="d-flex justify-content-between">
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ManageAccounts" OnClick="() => GoToDetails(c)">Manage</MudButton>
                        <div>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="() => EditCustomer(c)" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => ConfirmDelete(c)" />
                        </div>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>

    @if (!FilteredCustomers.Any())
    {
        <MudText>No customers found.</MudText>
    }
</MudPaper>

@code {
    private List<Customer> customers = new();
    private string search = string.Empty;

    private IEnumerable<Customer> FilteredCustomers => string.IsNullOrWhiteSpace(search)
        ? customers
        : customers.Where(c =>
            (c.Name?.Contains(search, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (c.Id?.Contains(search, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (c.NotificationEmails?.Any(e => e.Contains(search, StringComparison.OrdinalIgnoreCase)) ?? false));

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomers();
    }

    private async Task LoadCustomers()
    {
        try
        {
            customers = (await CustomerRepository.ListAsync(limit: 1000)).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load customers");
            Snackbar.Add($"Failed to load customers: {ex.Message}", Severity.Error);
        }
    }

    private async Task CreateCustomer()
    {
        var parameters = new DialogParameters
        {
            [nameof(Shared.CustomerEditDialog.Model)] = new Customer(),
            [nameof(Shared.CustomerEditDialog.IsEdit)] = false
        };
        var options = new DialogOptions { CloseButton = false, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<Shared.CustomerEditDialog>("Add Customer", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled && result.Data is Customer created)
        {
            try
            {
                created.CreatedAt = DateTime.UtcNow;
                created.UpdatedAt = DateTime.UtcNow;
                await CustomerRepository.CreateAsync(created);
                Snackbar.Add($"Customer '{created.Name}' created", Severity.Success);
                await LoadCustomers();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, message:"Failed to create customer");
                Snackbar.Add(message: $"Failed to create customer: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task EditCustomer(Customer customer)
    {
        var parameters = new DialogParameters
        {
            [nameof(Shared.CustomerEditDialog.Model)] = customer,
            [nameof(Shared.CustomerEditDialog.IsEdit)] = true
        };
        var options = new DialogOptions { CloseButton = false, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<Shared.CustomerEditDialog>($"Edit {customer.Name}", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled && result.Data is Customer edited)
        {
            try
            {
                await CustomerRepository.UpdateAsync(customer.Id, edited);
                Snackbar.Add($"Customer '{edited.Name}' updated", Severity.Success);
                await LoadCustomers();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to update customer");
                Snackbar.Add($"Failed to update customer: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ConfirmDelete(Customer customer)
    {
        var confirmed = await DialogService.ShowMessageBox(
            title: "Delete Customer",
            markupMessage: (MarkupString)$"Are you sure you want to delete '<strong>{customer.Name}</strong>'?",
            yesText: "Delete",
            cancelText: "Cancel",
            options: new DialogOptions { MaxWidth = MaxWidth.Small });

        if (confirmed == true)
        {
            try
            {
                var ok = await CustomerRepository.DeleteAsync(customer.Id);
                if (ok)
                {
                    Snackbar.Add($"Customer '{customer.Name}' deleted", Severity.Success);
                    await LoadCustomers();
                }
                else
                {
                    Snackbar.Add("Customer not found", Severity.Warning);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to delete customer");
                Snackbar.Add($"Failed to delete customer: {ex.Message}", Severity.Error);
            }
        }
    }

    private void GoToDetails(Customer c) => Nav.NavigateTo($"/customers/{c.Id}");

    private static string Short(string? value, int max = 10)
        => string.IsNullOrEmpty(value) ? "-" : (value!.Length > max ? value.Substring(0, max) + "..." : value);
}
