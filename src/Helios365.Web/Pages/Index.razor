@page "/"
@attribute [Authorize(Policy = "ReaderOrAbove")]
@using Helios365.Core.Models
@using Helios365.Core.Repositories
@inject IAlertRepository AlertRepository
@inject ILogger<Index> Logger

<PageTitle>Helios365 Dashboard</PageTitle>

<MudText Typo="Typo.h4" Class="mb-2">Dashboard</MudText>
<MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">Quick status overview with deep links into Alerts.</MudText>

@if (isLoading)
{
    <div class="text-center py-5">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" Class="mb-2" />
        <MudText Color="Color.Secondary">Loading dashboard...</MudText>
    </div>
}
else
{
    <div class="d-flex flex-wrap gap-3 align-items-center mb-4">
        @if (CriticalOpenCount == 0)
        {
            <MudChip T="string" Color="Color.Success" Variant="Variant.Filled">All clear</MudChip>
        }
        else
        {
            <MudChip T="string" Color="Color.Error" Variant="Variant.Filled">@CriticalOpenCount critical open</MudChip>
        }
    </div>

    <MudGrid>
        <MudItem xs="12" sm="6" xl="3">
            <MudCard Elevation="1" Class="h-100 cursor-pointer" @onclick="@(() => NavigateToAlerts("unsolved"))">
                <MudCardContent>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Active alerts</MudText>
                        <MudIcon Icon="@Icons.Material.Filled.Notifications" Color="Color.Primary" />
                    </div>
                    <MudText Typo="Typo.h3" Color="Color.Primary">@ActiveAlertsCount</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">View open alerts</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" xl="3">
            <MudCard Elevation="1" Class="h-100 cursor-pointer" @onclick="@(() => NavigateToAlerts("unsolved", "Critical"))">
                <MudCardContent>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Critical open</MudText>
                        <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" />
                    </div>
                    <MudText Typo="Typo.h3" Color="Color.Error">@CriticalOpenCount</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Filter critical in Alerts</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" xl="3">
            <MudCard Elevation="1" Class="h-100 cursor-pointer" @onclick="@(() => NavigateToAlerts("Escalated"))">
                <MudCardContent>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Escalated</MudText>
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Warning" />
                    </div>
                    <MudText Typo="Typo.h3" Color="Color.Warning">@EscalatedCount</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Go to escalated</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" xl="3">
            <MudCard Elevation="1" Class="h-100 cursor-pointer" @onclick="@(() => NavigateToAlerts("Resolved"))">
                <MudCardContent>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Resolved today</MudText>
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                    </div>
                    <MudText Typo="Typo.h3" Color="Color.Success">@ResolvedTodayCount</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Includes healthy</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
}

@code {
    [Inject] private NavigationManager NavigationManager { get; set; } = default!;

    private bool isLoading = true;
    private bool isRefreshing;
    private DateTime lastUpdatedUtc = DateTime.UtcNow;

    private int ActiveAlertsCount { get; set; }
    private int CriticalOpenCount { get; set; }
    private int EscalatedCount { get; set; }
    private int ResolvedTodayCount { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardAsync();
    }

    private async Task Reload()
    {
        if (isRefreshing)
        {
            return;
        }

        isRefreshing = true;
        await LoadDashboardAsync();
        isRefreshing = false;
    }

    private async Task LoadDashboardAsync()
    {
        isLoading = true;
        try
        {
            var now = DateTime.UtcNow;
            var alerts = (await AlertRepository.ListAsync(limit: 400)).ToList();

            lastUpdatedUtc = now;

            var activeAlerts = alerts.Where(a => a.IsActive()).ToList();
            ActiveAlertsCount = activeAlerts.Count;
            CriticalOpenCount = activeAlerts.Count(a => a.Severity == AlertSeverity.Critical);
            EscalatedCount = activeAlerts.Count(a => a.Status == AlertStatus.Escalated);
            ResolvedTodayCount = alerts.Count(a =>
                (a.Status == AlertStatus.Resolved || a.Status == AlertStatus.Healthy) &&
                a.ResolvedAt.HasValue &&
                a.ResolvedAt.Value.Date == now.Date);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading dashboard data");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void NavigateToAlerts(string status, string? severity = null)
    {
        var url = $"/alerts?status={status}";
        if (!string.IsNullOrEmpty(severity))
        {
            url += $"&severity={severity}";
        }
        NavigationManager.NavigateTo(url);
    }
}
