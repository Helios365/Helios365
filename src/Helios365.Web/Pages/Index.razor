@page "/"
@attribute [Authorize(Policy = "ReaderOrAbove")]
@using System.Linq
@using Helios365.Core.Models
@using Helios365.Core.Repositories
@using Helios365.Core.Utilities
@inject IAlertRepository AlertRepository
@inject ICustomerRepository CustomerRepository
@inject IResourceRepository ResourceRepository
@inject ILogger<Index> Logger

<PageTitle>Helios365 Dashboard</PageTitle>

<h1 class="display-5 mb-2">Dashboard</h1>
<p class="text-muted mb-4">Single view for everyone: quick status, trends, and deep links into Alerts.</p>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="d-flex flex-wrap gap-3 align-items-center mb-4">
        @if (CriticalOpenCount == 0)
        {
            <span class="badge bg-success text-white">All clear for @StabilityMessage</span>
        }
        else
        {
            <span class="badge bg-danger text-white">Oldest critical open @StabilityMessage ago</span>
        }
        <div class="text-muted small">Last updated @lastUpdatedUtc.ToLocalTime().ToString("HH:mm:ss")</div>
        <button class="btn btn-outline-primary btn-sm" disabled="@isRefreshing" @onclick="Reload">
            <i class="bi bi-arrow-clockwise me-1"></i>@(isRefreshing ? "Refreshing..." : "Refresh")
        </button>
    </div>

    <!-- Snapshot cards -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-xl-3">
            <a class="card border-0 shadow-sm h-100 text-decoration-none" href="/alerts?status=unsolved">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="text-muted small">Active alerts</span>
                        <i class="bi bi-lightning-charge text-primary"></i>
                    </div>
                    <div class="display-6 text-primary">@ActiveAlertsCount</div>
                    <div class="text-muted small">View open alerts</div>
                </div>
            </a>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
            <a class="card border-0 shadow-sm h-100 text-decoration-none" href="/alerts?status=unsolved&severity=Critical">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="text-muted small">Critical open</span>
                        <i class="bi bi-exclamation-triangle text-danger"></i>
                    </div>
                    <div class="display-6 text-danger">@CriticalOpenCount</div>
                    <div class="text-muted small">Filter critical in Alerts</div>
                </div>
            </a>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
            <a class="card border-0 shadow-sm h-100 text-decoration-none" href="/alerts?status=Escalated">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="text-muted small">Escalated</span>
                        <i class="bi bi-arrow-up-right-circle text-warning"></i>
                    </div>
                    <div class="display-6 text-warning">@EscalatedCount</div>
                    <div class="text-muted small">Go to escalated</div>
                </div>
            </a>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
            <a class="card border-0 shadow-sm h-100 text-decoration-none" href="/alerts?status=Resolved">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="text-muted small">Resolved today</span>
                        <i class="bi bi-check-circle text-success"></i>
                    </div>
                    <div class="display-6 text-success">@ResolvedTodayCount</div>
                    <div class="text-muted small">Includes healthy</div>
                </div>
            </a>
        </div>
    </div>

    <!-- Trends -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-lg-4">
            <a class="card border-0 shadow-sm h-100 text-decoration-none" href="/alerts">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="text-muted small">Alerts per hour (24h)</span>
                        <span class="badge bg-light text-dark border">avg @AlertsPerHourAverage:F1</span>
                    </div>
                    <div class="d-flex align-items-end gap-1 mt-3">
                        @for (var i = 0; i < alertsPerHour.Count; i++)
                        {
                            var value = alertsPerHour[i];
                            var height = MaxAlertsPerHour > 0 ? Math.Max(8, (int)Math.Round(value / (double)MaxAlertsPerHour * 40)) : 8;
                            <div class="bg-primary rounded-1" style=$"width:8px; height:{height}px;"></div>
                        }
                    </div>
                    <div class="text-muted small mt-2">Last 24h</div>
                </div>
            </a>
        </div>
        <div class="col-12 col-lg-4">
            <a class="card border-0 shadow-sm h-100 text-decoration-none" href="/alerts?status=Resolved">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="text-muted small">Resolution time</span>
                        <span class="badge bg-light text-dark border">7d avg</span>
                    </div>
                    <div class="d-flex align-items-baseline gap-3 mt-2">
                        <div>
                            <div class="fw-semibold">Today</div>
                            <div class="h4 mb-0">@FormatDuration(mttrToday)</div>
                        </div>
                        <div>
                            <div class="fw-semibold">7d</div>
                            <div class="h5 mb-0 text-muted">@FormatDuration(mttr7d)</div>
                        </div>
                    </div>
                    <div class="text-muted small mt-2">Based on resolved alerts</div>
                </div>
            </a>
        </div>
        <div class="col-12 col-lg-4">
            <a class="card border-0 shadow-sm h-100 text-decoration-none" href="/alerts?status=Escalated">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="text-muted small">Escalation rate (7d)</span>
                        <span class="badge bg-light text-dark border">@Escalations7d / @TotalAlerts7d</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-warning" role="progressbar" style=$"width:{Math.Min(100, EscalationRate7d * 100):F0}%;" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="h4 mt-2 mb-0">@EscalationRate7d:P0</div>
                    <div class="text-muted small">Last 7 days</div>
                </div>
            </a>
        </div>
    </div>

    <!-- Noisy items -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-xl-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Top customers</h6>
                        <a href="/alerts" class="text-muted small text-decoration-none">View all</a>
                    </div>
                    @if (topCustomers.Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var customer in topCustomers)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <div>
                                        <a class="fw-semibold text-decoration-none" href="@customer.Link">@customer.Label</a>
                                        <div class="text-muted small">@customer.SubLabel</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-semibold">@customer.Count</div>
                                        @if (customer.CriticalCount > 0)
                                        {
                                            <span class="badge bg-danger text-white">Critical @customer.CriticalCount</span>
                                        }
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <div class="text-muted small">No customer data yet.</div>
                    }
                </div>
            </div>
        </div>
        <div class="col-12 col-xl-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Top resources</h6>
                        <a href="/alerts" class="text-muted small text-decoration-none">View all</a>
                    </div>
                    @if (topResources.Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var resource in topResources)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <div>
                                        <a class="fw-semibold text-decoration-none" href="@resource.Link">@resource.Label</a>
                                        <div class="text-muted small">@resource.SubLabel</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-semibold">@resource.Count</div>
                                        @if (resource.CriticalCount > 0)
                                        {
                                            <span class="badge bg-danger text-white">Critical @resource.CriticalCount</span>
                                        }
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <div class="text-muted small">No resource data yet.</div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Recent criticals -->
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">Recent critical or escalated</h6>
                <a href="/alerts?status=unsolved&severity=Critical" class="text-muted small text-decoration-none">View filtered</a>
            </div>
            @if (recentCriticals.Any())
            {
                <div class="list-group list-group-flush">
                    @foreach (var alert in recentCriticals)
                    {
                        <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-start px-0" href="/alerts/@alert.Id">
                            <div class="me-3">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge rounded-pill @GetSeverityBadgeClass(alert.Severity)">@alert.Severity</span>
                                    <span class="badge rounded-pill @GetStatusBadgeClass(alert.Status)">@alert.Status</span>
                                </div>
                                <div class="fw-semibold mt-1">@(!string.IsNullOrWhiteSpace(alert.Title) ? alert.Title : "(no title)")</div>
                                <div class="text-muted small">
                                    @GetCustomerName(alert.CustomerId) · @GetResourceLabel(alert)
                                </div>
                            </div>
                            <div class="text-end text-muted small">
                                <div>Updated @FormatAgo(alert.UpdatedAt)</div>
                                <div>Created @alert.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</div>
                            </div>
                        </a>
                    }
                </div>
            }
            else
            {
                <div class="text-muted small">No critical or escalated alerts right now.</div>
            }
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private bool isRefreshing;
    private DateTime lastUpdatedUtc = DateTime.UtcNow;

    public int ActiveAlertsCount { get; set; }
    public int CriticalOpenCount { get; set; }
    public int EscalatedCount { get; set; }
    public int ResolvedTodayCount { get; set; }

    private IReadOnlyList<int> alertsPerHour = Array.Empty<int>();
    private int MaxAlertsPerHour => alertsPerHour.Count > 0 ? alertsPerHour.Max() : 0;
    private double AlertsPerHourAverage => alertsPerHour.Count > 0 ? alertsPerHour.Average() : 0;

    private TimeSpan? mttrToday;
    private TimeSpan? mttr7d;

    private double EscalationRate7d { get; set; }
    private int Escalations7d { get; set; }
    private int TotalAlerts7d { get; set; }

    private List<TopItem> topCustomers = new();
    private List<TopItem> topResources = new();
    private List<Alert> recentCriticals = new();

    private Dictionary<string, Customer> customers = new();
    private Dictionary<string, string> resourceLookup = new(StringComparer.OrdinalIgnoreCase);
    private string StabilityMessage { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardAsync();
    }

    private async Task Reload()
    {
        if (isRefreshing)
        {
            return;
        }

        isRefreshing = true;
        await LoadDashboardAsync();
        isRefreshing = false;
    }

    private async Task LoadDashboardAsync()
    {
        isLoading = true;
        try
        {
            var now = DateTime.UtcNow;
            var alerts = (await AlertRepository.ListAsync(limit: 400)).ToList();

            lastUpdatedUtc = now;

            // Lookups
            customers = (await CustomerRepository.ListAsync(limit: 200)).ToDictionary(c => c.Id, c => c);
            var customerIds = alerts.Select(a => a.CustomerId).Distinct().ToList();
            resourceLookup = await BuildResourceLookupAsync(customerIds);

            // Counts
            var activeAlerts = alerts.Where(a => a.IsActive()).ToList();
            ActiveAlertsCount = activeAlerts.Count;
            CriticalOpenCount = activeAlerts.Count(a => a.Severity == AlertSeverity.Critical);
            EscalatedCount = activeAlerts.Count(a => a.Status == AlertStatus.Escalated);
            ResolvedTodayCount = alerts.Count(a =>
                (a.Status == AlertStatus.Resolved || a.Status == AlertStatus.Healthy) &&
                a.ResolvedAt.HasValue &&
                a.ResolvedAt.Value.Date == now.Date);

            // Trends
            alertsPerHour = BuildHourlySeries(alerts, now);
            mttrToday = CalculateAverageResolution(alerts.Where(a => a.ResolvedAt.HasValue && a.ResolvedAt.Value >= now.Date));
            mttr7d = CalculateAverageResolution(alerts.Where(a => a.ResolvedAt.HasValue && a.ResolvedAt.Value >= now.AddDays(-7)));

            var last7Days = alerts.Where(a => a.CreatedAt >= now.AddDays(-7)).ToList();
            TotalAlerts7d = last7Days.Count;
            Escalations7d = last7Days.Count(a => a.Status == AlertStatus.Escalated || (a.EscalatedAt.HasValue && a.EscalatedAt.Value >= now.AddDays(-7)));
            EscalationRate7d = TotalAlerts7d > 0 ? Escalations7d / (double)TotalAlerts7d : 0;

            // Noisy (top) lists
            topCustomers = alerts
                .GroupBy(a => a.CustomerId)
                .Select(g => new
                {
                    Id = g.Key,
                    Count = g.Count(),
                    Criticals = g.Count(a => a.Severity == AlertSeverity.Critical && a.IsActive())
                })
                .OrderByDescending(x => x.Count)
                .Take(3)
                .Select(x =>
                {
                    var name = customers.TryGetValue(x.Id, out var c) && !string.IsNullOrWhiteSpace(c.Name)
                        ? c.Name
                        : x.Id;
                    return new TopItem(name, x.Count, x.Criticals, $"/alerts?customer={Uri.EscapeDataString(x.Id)}", "Alerts for this customer");
                })
                .ToList();

            topResources = alerts
                .GroupBy(a => (a.CustomerId, ResourceKey: Normalizers.NormalizeResourceId(a.ResourceId)))
                .Select(g => new
                {
                    g.Key.CustomerId,
                    g.Key.ResourceKey,
                    Count = g.Count(),
                    Criticals = g.Count(a => a.Severity == AlertSeverity.Critical && a.IsActive())
                })
                .OrderByDescending(x => x.Count)
                .Take(3)
                .Select(x =>
                {
                    var resourceKey = $"{x.CustomerId}|{x.ResourceKey}";
                    var resourceName = resourceLookup.TryGetValue(resourceKey, out var name) ? name : x.ResourceKey;
                    var customerName = customers.TryGetValue(x.CustomerId, out var c) && !string.IsNullOrWhiteSpace(c.Name)
                        ? c.Name
                        : x.CustomerId;
                    var label = !string.IsNullOrWhiteSpace(resourceName) ? resourceName : "(resource)";
                    var subLabel = $"Customer: {customerName}";
                    var link = $"/alerts?customer={Uri.EscapeDataString(x.CustomerId)}&search={Uri.EscapeDataString(x.ResourceKey)}";
                    return new TopItem(label, x.Count, x.Criticals, link, subLabel);
                })
                .ToList();

            recentCriticals = alerts
                .Where(a => a.Severity == AlertSeverity.Critical || a.Status == AlertStatus.Escalated)
                .OrderByDescending(a => a.UpdatedAt)
                .Take(5)
                .ToList();

            StabilityMessage = BuildStabilityMessage(activeAlerts, alerts, now);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading dashboard data");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task<Dictionary<string, string>> BuildResourceLookupAsync(IEnumerable<string> customerIds)
    {
        var lookup = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        foreach (var customerId in customerIds)
        {
            if (string.IsNullOrWhiteSpace(customerId))
            {
                continue;
            }

            var resources = await ResourceRepository.ListByCustomerAsync(customerId, limit: 200);
            foreach (var resource in resources)
            {
                var key = $"{customerId}|{Normalizers.NormalizeResourceId(resource.ResourceId)}";
                lookup[key] = string.IsNullOrWhiteSpace(resource.Name) ? resource.ResourceId : resource.Name;
            }
        }

        return lookup;
    }

    private static IReadOnlyList<int> BuildHourlySeries(IEnumerable<Alert> alerts, DateTime nowUtc)
    {
        var buckets = Enumerable.Repeat(0, 24).ToArray();
        foreach (var alert in alerts)
        {
            var hoursAgo = (int)Math.Floor((nowUtc - alert.CreatedAt).TotalHours);
            if (hoursAgo >= 0 && hoursAgo < 24)
            {
                var index = 23 - hoursAgo; // 0 = oldest, 23 = latest hour
                buckets[index]++;
            }
        }

        return buckets;
    }

    private static TimeSpan? CalculateAverageResolution(IEnumerable<Alert> alerts)
    {
        var durations = alerts
            .Where(a => a.ResolvedAt.HasValue && a.ResolvedAt.Value >= a.CreatedAt)
            .Select(a => a.ResolvedAt!.Value - a.CreatedAt)
            .Where(d => d.TotalSeconds >= 0)
            .ToList();

        if (!durations.Any())
        {
            return null;
        }

        var averageSeconds = durations.Average(d => d.TotalSeconds);
        return TimeSpan.FromSeconds(averageSeconds);
    }

    private string BuildStabilityMessage(IEnumerable<Alert> activeAlerts, IEnumerable<Alert> allAlerts, DateTime now)
    {
        var activeCritical = activeAlerts.Where(a => a.Severity == AlertSeverity.Critical).OrderBy(a => a.CreatedAt).FirstOrDefault();
        if (activeCritical != null)
        {
            return FormatDuration(now - activeCritical.CreatedAt);
        }

        var lastCritical = allAlerts.Where(a => a.Severity == AlertSeverity.Critical).OrderByDescending(a => a.CreatedAt).FirstOrDefault();
        if (lastCritical != null)
        {
            return FormatDuration(now - lastCritical.CreatedAt);
        }

        return "a while";
    }

    private string GetCustomerName(string customerId)
    {
        if (customers.TryGetValue(customerId, out var customer) && !string.IsNullOrWhiteSpace(customer.Name))
        {
            return customer.Name;
        }

        return customerId;
    }

    private string GetResourceLabel(Alert alert)
    {
        var key = $"{alert.CustomerId}|{Normalizers.NormalizeResourceId(alert.ResourceId)}";
        if (resourceLookup.TryGetValue(key, out var name) && !string.IsNullOrWhiteSpace(name))
        {
            return name;
        }

        return string.IsNullOrWhiteSpace(alert.ResourceId) ? "(resource unknown)" : alert.ResourceId;
    }

    private string FormatAgo(DateTime utc)
    {
        var delta = DateTime.UtcNow - utc;
        return $"{FormatDuration(delta)} ago";
    }

    private string FormatDuration(TimeSpan? duration)
    {
        if (duration is null)
        {
            return "—";
        }

        var value = duration.Value;
        if (value.TotalHours >= 1)
        {
            return $"{Math.Floor(value.TotalHours)}h {value.Minutes}m";
        }

        if (value.TotalMinutes >= 1)
        {
            return $"{Math.Floor(value.TotalMinutes)}m";
        }

        return $"{Math.Max(1, value.Seconds)}s";
    }

    private string GetStatusBadgeClass(AlertStatus status)
    {
        return status switch
        {
            AlertStatus.Received => "bg-secondary",
            AlertStatus.Routing => "bg-info",
            AlertStatus.Checking => "bg-info",
            AlertStatus.Remediating => "bg-warning text-dark",
            AlertStatus.Rechecking => "bg-info",
            AlertStatus.Resolved => "bg-success",
            AlertStatus.Healthy => "bg-success",
            AlertStatus.Escalated => "bg-danger",
            AlertStatus.Failed => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetSeverityBadgeClass(AlertSeverity severity)
    {
        return severity switch
        {
            AlertSeverity.Critical => "bg-danger",
            AlertSeverity.High => "bg-warning text-dark",
            AlertSeverity.Medium => "bg-info",
            AlertSeverity.Low => "bg-secondary",
            AlertSeverity.Info => "bg-light text-dark",
            _ => "bg-secondary"
        };
    }

    private sealed record TopItem(string Label, int Count, int CriticalCount, string Link, string? SubLabel = null);
}

