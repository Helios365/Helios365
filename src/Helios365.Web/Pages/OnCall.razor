@page "/oncall"
@attribute [Authorize(Policy = "ReaderOrAbove")]
@using System.Linq
@using Helios365.Core.Models
@using Helios365.Core.Repositories
@using Helios365.Core.Services
@inject IOnCallPlanRepository PlanRepository
@inject IOnCallTeamRepository TeamRepository
@inject ICustomerPlanBindingRepository BindingRepository
@inject ICustomerRepository CustomerRepository
@inject IOnCallScheduleService ScheduleService
@inject IUserRepository UserRepository
@inject ISnackbar Snackbar
@inject ILogger<OnCall> Logger

<PageTitle>On-Call Administration</PageTitle>

<h1 class="display-5 mb-2">On-Call</h1>
<p class="text-muted mb-4">Manage reusable plans, teams, and customer bindings. Bindings trigger schedule generation.</p>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="row g-3">
        <div class="col-12 col-xl-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Plans</h5>
                        <span class="badge bg-light text-dark border">@plans.Count</span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input class="form-control" @bind="newPlan.Name" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Time zone</label>
                        <input class="form-control" @bind="newPlan.TimeZone" placeholder="e.g., Europe/Stockholm" />
                    </div>
                    <div class="mb-3 row g-2">
                        <div class="col-6">
                            <label class="form-label">On-hours start</label>
                            <InputText class="form-control" type="time" @bind-Value="newPlan.Start" />
                        </div>
                        <div class="col-6">
                            <label class="form-label">On-hours end</label>
                            <InputText class="form-control" type="time" @bind-Value="newPlan.End" />
                        </div>
                    </div>
                    <div class="form-check mb-2">
                        <InputCheckbox class="form-check-input" @bind-Value="newPlan.IncludeWeekends" />
                        <label class="form-check-label">Include weekends</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Holidays (YYYY-MM-DD, comma-separated)</label>
                        <InputText class="form-control" @bind-Value="newPlan.Holidays" placeholder="2025-12-25,2025-12-26" />
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-primary" @onclick="SavePlanAsync" disabled="@isSaving">@((editingPlan != null) ? "Save plan" : "Add plan")</button>
                        @if (editingPlan != null)
                        {
                            <button class="btn btn-outline-secondary" @onclick="CancelPlanEdit">Cancel</button>
                        }
                    </div>
                    <hr />
                    <ul class="list-group list-group-flush">
                        @if (plans.Any())
                        {
                            @foreach (var plan in plans)
                            {
                                <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold">@plan.Name</div>
                                        <div class="text-muted small">@plan.TimeZone - On-hours @FormatOnHours(plan)</div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => StartEditPlan(plan)">Edit</button>
                                        <span class="badge bg-light text-dark border">v @plan.Version</span>
                                    </div>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="list-group-item px-0 text-muted small">No plans yet.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-12 col-xl-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Teams</h5>
                        <span class="badge bg-light text-dark border">@teams.Count</span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input class="form-control" @bind="newTeam.Name" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Members</label>
                        <select class="form-select" multiple size="6" @onchange="OnUserSelectionChanged">
                            @if (availableUsers.Any())
                            {
                                @foreach (var user in availableUsers)
                                {
                                    <option value="@user.Id" selected="@newTeam.SelectedUserIds.Contains(user.Id)">@user.DisplayName (@user.UserPrincipalName)</option>
                                }
                            }
                            else
                            {
                                <option disabled>No users found</option>
                            }
                        </select>
                        <div class="form-text">Use Ctrl/Cmd + click to select multiple. Optional: add extra user ids below.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Extra members (user ids, comma-separated)</label>
                        <input class="form-control" @bind="newTeam.ManualMembers" placeholder="user1,user2" />
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="whole-team" @bind="newTeam.WholeTeam" />
                        <label class="form-check-label" for="whole-team">Whole team on-call (no rotation)</label>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-primary" @onclick="SaveTeamAsync" disabled="@isSaving">@((editingTeam != null) ? "Save team" : "Add team")</button>
                        @if (editingTeam != null)
                        {
                            <button class="btn btn-outline-secondary" @onclick="CancelTeamEdit">Cancel</button>
                        }
                    </div>
                    <hr />
                    <ul class="list-group list-group-flush">
                        @if (teams.Any())
                        {
                            @foreach (var team in teams)
                            {
                                <li class="list-group-item px-0">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <div class="fw-semibold">@team.Name</div>
                                            <div class="text-muted small">@team.Members.Count(m => m.Enabled) enabled members</div>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-light text-dark border">@((team.ModeOverride ?? RotationMode.RollingIndividual).ToString())</span>
                                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => StartEditTeam(team)">Edit</button>
                                        </div>
                                    </div>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="list-group-item px-0 text-muted small">No teams yet.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-12 col-xl-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Customer binding</h5>
                        <span class="badge bg-light text-dark border">@bindings.Count</span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Customer</label>
                        <select class="form-select" @bind="newBinding.CustomerId">
                            <option value="">Select customer</option>
                            @foreach (var c in customers)
                            {
                                <option value="@c.Id">@(!string.IsNullOrWhiteSpace(c.Name) ? c.Name : c.Id)</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Plan</label>
                        <select class="form-select" @bind="newBinding.PlanId">
                            <option value="">Select plan</option>
                            @foreach (var p in plans)
                            {
                                <option value="@p.Id">@p.Name</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">On-hours team</label>
                        <select class="form-select" @bind="newBinding.OnTeamId">
                            <option value="">Select team</option>
                            @foreach (var t in teams)
                            {
                                <option value="@t.Id">@t.Name</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Off-hours team</label>
                        <select class="form-select" @bind="newBinding.OffTeamId">
                            <option value="">Select team</option>
                            @foreach (var t in teams)
                            {
                                <option value="@t.Id">@t.Name</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Backup team</label>
                        <select class="form-select" @bind="newBinding.BackupTeamId">
                            <option value="">Select team</option>
                            @foreach (var t in teams)
                            {
                                <option value="@t.Id">@t.Name</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Effective from</label>
                        <input class="form-control" type="date" @bind="newBinding.EffectiveFrom" />
                    </div>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary" @onclick="SaveBindingAsync" disabled="@isSaving">@((editingBinding != null) ? "Save binding" : "Bind & regenerate")</button>
                        @if (editingBinding != null)
                        {
                            <button class="btn btn-outline-secondary ms-2" @onclick="CancelBindingEdit">Cancel</button>
                        }
                    </div>
                    <hr />
                    <ul class="list-group list-group-flush">
                        @if (bindings.Any())
                        {
                            @foreach (var b in bindings)
                            {
                                var customerName = customers.FirstOrDefault(c => c.Id == b.CustomerId)?.Name ?? b.CustomerId;
                                var planName = plans.FirstOrDefault(p => p.Id == b.PlanDefinitionId)?.Name ?? b.PlanDefinitionId;
                                var onTeam = teams.FirstOrDefault(t => t.Id == b.OnHoursTeamId)?.Name ?? b.OnHoursTeamId;
                                var offTeam = teams.FirstOrDefault(t => t.Id == b.OffHoursTeamId)?.Name ?? b.OffHoursTeamId;
                                var backupTeam = teams.FirstOrDefault(t => t.Id == b.BackupTeamId)?.Name ?? b.BackupTeamId;
                                <li class="list-group-item px-0">
                                    <div class="fw-semibold">@customerName</div>
                                    <div class="text-muted small">@planName</div>
                                    <div class="text-muted small">On: @onTeam · Off: @offTeam · Backup: @backupTeam</div>
                                    <div class="mt-1">
                                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => StartEditBinding(b)">Edit</button>
                                    </div>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="list-group-item px-0 text-muted small">No bindings yet.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private readonly int regenerationHorizonDays = 60;

    private bool isLoading = true;
    private bool isSaving;

    private List<OnCallPlan> plans = new();
    private List<OnCallTeam> teams = new();
    private List<CustomerPlanBinding> bindings = new();
    private List<Customer> customers = new();
    private List<User> availableUsers = new();

    private PlanInput newPlan = new();
    private OnCallPlan? editingPlan;
    private TeamInput newTeam = new();
    private OnCallTeam? editingTeam;
    private BindingInput newBinding = new();
    private CustomerPlanBinding? editingBinding;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        isLoading = true;
        try
        {
            var planTask = PlanRepository.ListAsync(limit: 200);
            var teamTask = TeamRepository.ListAsync(limit: 200);
            var bindingTask = BindingRepository.ListAsync(limit: 200);
            var customerTask = CustomerRepository.ListActiveAsync(limit: 200);
            var usersTask = UserRepository.ListAsync(limit: 500);

            await Task.WhenAll(planTask, teamTask, bindingTask, customerTask, usersTask);

            plans = planTask.Result.OrderBy(p => p.Name).ToList();
            teams = teamTask.Result.OrderBy(t => t.Name).ToList();
            bindings = bindingTask.Result.OrderBy(b => b.CustomerId).ToList();
            customers = customerTask.Result.OrderBy(c => c.Name).ToList();
            availableUsers = usersTask.Result.OrderBy(u => u.DisplayName).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load on-call data");
            Snackbar.Add("Failed to load on-call data.", Severity.Error);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SavePlanAsync()
    {
        isSaving = true;
        try
        {
            if (string.IsNullOrWhiteSpace(newPlan.Name))
            {
                Snackbar.Add("Plan name is required.", Severity.Warning);
                return;
            }

            if (!TimeSpan.TryParse(newPlan.Start, out var start) || !TimeSpan.TryParse(newPlan.End, out var end))
            {
                Snackbar.Add("Invalid time range.", Severity.Warning);
                return;
            }

            var days = newPlan.IncludeWeekends
                ? new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday, DayOfWeek.Friday, DayOfWeek.Saturday }
                : new[] { DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday, DayOfWeek.Friday };

            var onHours = days
                .Select(d => new DailyWindow(d, start, end))
                .ToList();

            var holidays = (newPlan.Holidays ?? string.Empty)
                .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .Select(h => DateOnly.TryParse(h, out var date) ? (DateOnly?)date : null)
                .Where(d => d.HasValue)
                .Select(d => d!.Value)
                .ToList();

            if (editingPlan == null)
            {
                var plan = new OnCallPlan
                {
                    Name = newPlan.Name,
                    TimeZone = string.IsNullOrWhiteSpace(newPlan.TimeZone) ? "UTC" : newPlan.TimeZone,
                    OnHours = onHours,
                    IncludeWeekends = newPlan.IncludeWeekends,
                    Holidays = holidays,
                    Escalation = new EscalationPolicy(TimeSpan.FromMinutes(5), 3, TimeSpan.FromMinutes(5)),
                    Rotation = new RotationDefaults(RotationMode.RollingIndividual, RotationCadence.Daily, DateOnly.FromDateTime(DateTime.UtcNow.Date), 0),
                    Version = "v1"
                };

                await PlanRepository.UpsertAsync(plan);
                Snackbar.Add("Plan created.", Severity.Success);
            }
            else
            {
                var updated = editingPlan with
                {
                    Name = newPlan.Name,
                    TimeZone = string.IsNullOrWhiteSpace(newPlan.TimeZone) ? "UTC" : newPlan.TimeZone,
                    OnHours = onHours,
                    IncludeWeekends = newPlan.IncludeWeekends,
                    Holidays = holidays
                };
                await PlanRepository.UpsertAsync(updated);
                Snackbar.Add("Plan updated.", Severity.Success);
            }

            newPlan = new PlanInput();
            editingPlan = null;
            await LoadAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save plan");
            Snackbar.Add("Failed to save plan.", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void StartEditPlan(OnCallPlan plan)
    {
        editingPlan = plan;
        newPlan = new PlanInput
        {
            Name = plan.Name,
            TimeZone = plan.TimeZone,
            Start = plan.OnHours.FirstOrDefault()?.Start.ToString(@"hh\:mm") ?? "09:00",
            End = plan.OnHours.FirstOrDefault()?.End.ToString(@"hh\:mm") ?? "17:00",
            IncludeWeekends = plan.IncludeWeekends,
            Holidays = string.Join(",", plan.Holidays.Select(h => h.ToString("yyyy-MM-dd")))
        };
    }

    private void CancelPlanEdit()
    {
        editingPlan = null;
        newPlan = new PlanInput();
    }

    private async Task SaveTeamAsync()
    {
        isSaving = true;
        try
        {
            if (string.IsNullOrWhiteSpace(newTeam.Name))
            {
                Snackbar.Add("Team name is required.", Severity.Warning);
                return;
            }

            var members = newTeam.SelectedUserIds
                .Concat((newTeam.ManualMembers ?? string.Empty)
                    .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .Select((id, idx) => new TeamMember(id, Enabled: true, Order: idx))
                .ToList();

            if (!members.Any())
            {
                Snackbar.Add("Select at least one member.", Severity.Warning);
                return;
            }

            var modeOverride = newTeam.WholeTeam ? RotationMode.WholeTeam : RotationMode.RollingIndividual;

            if (editingTeam == null)
            {
                var team = new OnCallTeam
                {
                    Name = newTeam.Name,
                    ModeOverride = modeOverride,
                    Members = members
                };

                await TeamRepository.UpsertAsync(team);
                Snackbar.Add("Team created.", Severity.Success);
            }
            else
            {
                var updated = editingTeam with
                {
                    Name = newTeam.Name,
                    ModeOverride = modeOverride,
                    Members = members
                };

                await TeamRepository.UpsertAsync(updated);
                Snackbar.Add("Team updated.", Severity.Success);
            }

            newTeam = new TeamInput();
            editingTeam = null;
            await LoadAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save team");
            Snackbar.Add("Failed to save team.", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void StartEditTeam(OnCallTeam team)
    {
        editingTeam = team;
        newTeam = new TeamInput
        {
            Name = team.Name,
            WholeTeam = (team.ModeOverride ?? RotationMode.RollingIndividual) == RotationMode.WholeTeam,
            SelectedUserIds = team.Members.Where(m => m.Enabled).Select(m => m.UserId).ToList(),
            ManualMembers = string.Empty
        };
    }

    private void CancelTeamEdit()
    {
        editingTeam = null;
        newTeam = new TeamInput();
    }

    private void StartEditBinding(CustomerPlanBinding binding)
    {
        editingBinding = binding;
        newBinding = new BindingInput
        {
            CustomerId = binding.CustomerId,
            PlanId = binding.PlanDefinitionId,
            OnTeamId = binding.OnHoursTeamId,
            OffTeamId = binding.OffHoursTeamId,
            BackupTeamId = binding.BackupTeamId,
            EffectiveFrom = binding.EffectiveFrom.ToDateTime(TimeOnly.MinValue)
        };
    }

    private void CancelBindingEdit()
    {
        editingBinding = null;
        newBinding = new BindingInput { EffectiveFrom = DateTime.UtcNow.Date };
    }

    private async Task SaveBindingAsync()
    {
        isSaving = true;
        try
        {
            if (string.IsNullOrWhiteSpace(newBinding.CustomerId) ||
                string.IsNullOrWhiteSpace(newBinding.PlanId) ||
                string.IsNullOrWhiteSpace(newBinding.OnTeamId) ||
                string.IsNullOrWhiteSpace(newBinding.OffTeamId) ||
                string.IsNullOrWhiteSpace(newBinding.BackupTeamId))
            {
                Snackbar.Add("Customer, plan, on/off/backup teams are required.", Severity.Warning);
                return;
            }

            var binding = new CustomerPlanBinding
            {
                Id = string.IsNullOrWhiteSpace(newBinding.CustomerId) ? newBinding.CustomerId : newBinding.CustomerId,
                CustomerId = newBinding.CustomerId,
                PlanDefinitionId = newBinding.PlanId,
                OnHoursTeamId = newBinding.OnTeamId,
                OffHoursTeamId = newBinding.OffTeamId,
                BackupTeamId = newBinding.BackupTeamId,
                EffectiveFrom = DateOnly.FromDateTime(newBinding.EffectiveFrom.Date)
            };

            await BindingRepository.UpsertAsync(binding);

            var now = DateTime.UtcNow;
            await ScheduleService.RegenerateAsync(binding.CustomerId, now, now.AddDays(regenerationHorizonDays));

            Snackbar.Add(editingBinding == null ? "Binding created and schedule regenerated." : "Binding updated and schedule regenerated.", Severity.Success);
            newBinding = new BindingInput { EffectiveFrom = DateTime.UtcNow.Date };
            editingBinding = null;
            await LoadAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save binding");
            Snackbar.Add("Failed to save binding.", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private static string FormatOnHours(OnCallPlan plan)
    {
        if (plan.OnHours.Count == 0) return "none";
        var first = plan.OnHours.First();
        var last = plan.OnHours.Last();
        return $"{first.Start:hh\\:mm}-{first.End:hh\\:mm} ({plan.OnHours.Count} windows)";
    }

    private sealed record PlanInput
    {
        public string Name { get; set; } = string.Empty;
        public string TimeZone { get; set; } = "UTC";
        public string Start { get; set; } = "09:00";
        public string End { get; set; } = "17:00";
        public bool IncludeWeekends { get; set; } = false;
        public string Holidays { get; set; } = string.Empty;
    }

    private sealed record TeamInput
    {
        public string Name { get; set; } = string.Empty;
        public List<string> SelectedUserIds { get; set; } = new();
        public string ManualMembers { get; set; } = string.Empty;
        public bool WholeTeam { get; set; }
    }

    private Task OnUserSelectionChanged(ChangeEventArgs e)
    {
        if (e.Value is string[] values)
        {
            newTeam.SelectedUserIds = values.ToList();
        }
        else if (e.Value is string single)
        {
            newTeam.SelectedUserIds = new List<string> { single };
        }
        else
        {
            newTeam.SelectedUserIds = new List<string>();
        }

        return Task.CompletedTask;
    }

    private sealed record BindingInput
    {
        public string CustomerId { get; set; } = string.Empty;
        public string PlanId { get; set; } = string.Empty;
        public string OnTeamId { get; set; } = string.Empty;
        public string OffTeamId { get; set; } = string.Empty;
        public string BackupTeamId { get; set; } = string.Empty;
        public DateTime EffectiveFrom { get; set; } = DateTime.UtcNow.Date;
    }
}

