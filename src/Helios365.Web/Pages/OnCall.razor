@page "/oncall"
@attribute [Authorize(Policy = "ReaderOrAbove")]
@using System.Globalization
@using Helios365.Core.Models
@using Helios365.Core.Services
@using MudBlazor
@inject IOnCallScheduleService ScheduleService
@inject ISnackbar Snackbar
@inject ILogger<OnCall> Logger

<PageTitle>On-Call Administration</PageTitle>

<MudText Typo="Typo.h4" Class="mb-1">On-Call</MudText>
<MudText Typo="Typo.subtitle2" Class="mb-4">Manage reusable plans, teams, bindings, and view the generated schedule.</MudText>

@if (isLoading)
{
    <div class="text-center py-5">
        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
    </div>
}
else
{
    <MudGrid GutterSize="3">
        <MudItem xs="12" lg="4">
            <MudCard Class="h-100">
                <MudCardContent>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <MudText Typo="Typo.h6">Plans</MudText>
                        <MudChip T="string" Variant="Variant.Outlined">@plans.Count</MudChip>
                    </div>
                    <MudTextField @bind-Value="newPlan.Name" Label="Name" Required="true" Class="mb-3" />
                    <MudTextField @bind-Value="newPlan.TimeZone" Label="Time zone" Placeholder="e.g., Europe/Stockholm" Class="mb-3" />
                    <MudGrid GutterSize="2" Class="mb-2">
                        <MudItem xs="6">
                            <MudTextField @bind-Value="newPlan.Start" Label="On-hours start" InputType="InputType.Time" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField @bind-Value="newPlan.End" Label="On-hours end" InputType="InputType.Time" />
                        </MudItem>
                    </MudGrid>
                    <MudCheckBox T="bool" @bind-Value="newPlan.IncludeWeekends" Label="Include weekends" Class="mb-2" />
                    <MudTextField @bind-Value="newPlan.Holidays" Label="Holidays (YYYY-MM-DD, comma-separated)" Placeholder="2025-12-25,2025-12-26" Class="mb-3" />
                    <div class="d-flex justify-content-end gap-2 mb-3">
                        <MudButton Color="Color.Primary" Variant="Variant.Filled" Disabled="isSaving" OnClick="SavePlanAsync">@((editingPlan != null) ? "Save plan" : "Add plan")</MudButton>
                        @if (editingPlan != null)
                        {
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="CancelPlanEdit">Cancel</MudButton>
                        }
                    </div>
                    <MudDivider />
                    <MudList T="object" Dense="true">
                        @if (plans.Any())
                        {
                            @foreach (var plan in plans)
                            {
                                <MudListItem>
                                    <div class="d-flex justify-content-between w-100 align-items-center">
                                        <div>
                                            <MudText Typo="Typo.subtitle2">@plan.Name</MudText>
                                            <MudText Typo="Typo.caption">@plan.TimeZone - On-hours @FormatOnHours(plan)</MudText>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => StartEditPlan(plan))">Edit</MudButton>
                                            <MudChip T="string" Variant="Variant.Outlined">v @plan.Version</MudChip>
                                        </div>
                                    </div>
                                </MudListItem>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Class="mt-2 text-muted">No plans yet.</MudText>
                        }
                    </MudList>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" lg="4">
            <MudCard Class="h-100">
                <MudCardContent>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <MudText Typo="Typo.h6">Teams</MudText>
                        <MudChip T="string" Variant="Variant.Outlined">@teams.Count</MudChip>
                    </div>
                    <MudTextField @bind-Value="newTeam.Name" Label="Name" Required="true" Class="mb-3" />
                    <MudSelect T="string"
                               Label="Members"
                               MultiSelection="true"
                               SelectedValues="newTeam.SelectedUserIds"
                               SelectedValuesChanged="@(args => OnUserSelectionChanged(args))"
                               ToStringFunc="ResolveUserDisplayName"
                               Dense="true"
                               Class="mb-2">
                        @if (availableUsers.Any())
                        {
                            @foreach (var user in availableUsers)
                            {
                                <MudSelectItem T="string" Value="@user.Id">@user.DisplayName (@user.UserPrincipalName)</MudSelectItem>
                            }
                        }
                        else
                        {
                            <MudSelectItem T="string" Disabled="true" Value="@string.Empty">No users found</MudSelectItem>
                        }
                    </MudSelect>
                    <MudText Typo="Typo.caption" Class="mb-2 text-muted">Optional: add extra user ids below.</MudText>
                    <MudTextField @bind-Value="newTeam.ManualMembers" Label="Extra members (user ids, comma-separated)" Placeholder="user1,user2" Class="mb-3" />
                    <MudSwitch T="bool" @bind-Value="newTeam.WholeTeam" Color="Color.Primary" Class="mb-3" Label="Whole team on-call (no rotation)" />
                    <MudTextField T="int?" @bind-Value="newTeam.RotationIntervalDays" Label="Rotation interval (days)" InputType="InputType.Number" Disabled="newTeam.WholeTeam" Class="mb-3" />
                    <div class="d-flex justify-content-end gap-2 mb-3">
                        <MudButton Color="Color.Primary" Variant="Variant.Filled" Disabled="isSaving" OnClick="SaveTeamAsync">@((editingTeam != null) ? "Save team" : "Add team")</MudButton>
                        @if (editingTeam != null)
                        {
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="CancelTeamEdit">Cancel</MudButton>
                        }
                    </div>
                    <MudDivider />
                    <MudList T="object" Dense="true">
                        @if (teams.Any())
                        {
                            @foreach (var team in teams)
                            {
                                <MudListItem>
                                    <div class="d-flex justify-content-between w-100 align-items-center">
                                        <div>
                                            <MudText Typo="Typo.subtitle2">@team.Name</MudText>
                                            <MudText Typo="Typo.caption">@team.Members.Count(m => m.Enabled) enabled members</MudText>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <MudChip T="string" Variant="Variant.Outlined">@((team.ModeOverride ?? RotationMode.RollingIndividual).ToString())</MudChip>
                                            <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => StartEditTeam(team))">Edit</MudButton>
                                        </div>
                                    </div>
                                </MudListItem>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Class="mt-2 text-muted">No teams yet.</MudText>
                        }
                    </MudList>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" lg="4">
            <MudCard Class="h-100">
                <MudCardContent>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <MudText Typo="Typo.h6">Customer binding</MudText>
                        <MudChip T="string" Variant="Variant.Outlined">@bindings.Count</MudChip>
                    </div>
                    <MudSelect T="string" Label="Customer" @bind-Value="newBinding.CustomerId" Dense="true" Class="mb-3">
                        <MudSelectItem T="string" Disabled="true" Value="@string.Empty">Select customer</MudSelectItem>
                        @foreach (var c in customers)
                        {
                            <MudSelectItem T="string" Value="@c.Id">@(!string.IsNullOrWhiteSpace(c.Name) ? c.Name : c.Id)</MudSelectItem>
                        }
                    </MudSelect>
                    <MudSelect T="string" Label="Plan" @bind-Value="newBinding.PlanId" Dense="true" Class="mb-3">
                        <MudSelectItem T="string" Disabled="true" Value="@string.Empty">Select plan</MudSelectItem>
                        @foreach (var p in plans)
                        {
                            <MudSelectItem T="string" Value="@p.Id">@p.Name</MudSelectItem>
                        }
                    </MudSelect>
                    <MudSelect T="string" Label="On-hours team" @bind-Value="newBinding.OnTeamId" Dense="true" Class="mb-3">
                        <MudSelectItem T="string" Disabled="true" Value="@string.Empty">Select team</MudSelectItem>
                        @foreach (var t in teams)
                        {
                            <MudSelectItem T="string" Value="@t.Id">@t.Name</MudSelectItem>
                        }
                    </MudSelect>
                    <MudSelect T="string" Label="Off-hours team" @bind-Value="newBinding.OffTeamId" Dense="true" Class="mb-3">
                        <MudSelectItem T="string" Disabled="true" Value="@string.Empty">Select team</MudSelectItem>
                        @foreach (var t in teams)
                        {
                            <MudSelectItem T="string" Value="@t.Id">@t.Name</MudSelectItem>
                        }
                    </MudSelect>
                    <MudSelect T="string" Label="Backup team" @bind-Value="newBinding.BackupTeamId" Dense="true" Class="mb-3">
                        <MudSelectItem T="string" Disabled="true" Value="@string.Empty">Select team</MudSelectItem>
                        @foreach (var t in teams)
                        {
                            <MudSelectItem T="string" Value="@t.Id">@t.Name</MudSelectItem>
                        }
                    </MudSelect>
                    <MudDatePicker @bind-Date="BindingEffectiveDate" Label="Effective from" Class="mb-3" />
                    <div class="d-flex justify-content-end gap-2 mb-3">
                        <MudButton Color="Color.Primary" Variant="Variant.Filled" Disabled="isSaving" OnClick="SaveBindingAsync">@((editingBinding != null) ? "Save binding" : "Bind & regenerate")</MudButton>
                        @if (editingBinding != null)
                        {
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="CancelBindingEdit">Cancel</MudButton>
                        }
                    </div>
                    <MudDivider />
                    <MudList T="object" Dense="true">
                        @if (bindings.Any())
                        {
                            @foreach (var b in bindings)
                            {
                                var customerName = customers.FirstOrDefault(c => c.Id == b.CustomerId)?.Name ?? b.CustomerId;
                                var planName = plans.FirstOrDefault(p => p.Id == b.PlanDefinitionId)?.Name ?? b.PlanDefinitionId;
                                var onTeam = ResolveTeamName(b.OnHoursTeamId);
                                var offTeam = ResolveTeamName(b.OffHoursTeamId);
                                var backupTeam = ResolveTeamName(b.BackupTeamId);
                                <MudListItem>
                                    <div class="fw-semibold">@customerName</div>
                                    <div class="text-muted small">@planName</div>
                                    <div class="text-muted small">On: @onTeam | Off: @offTeam | Backup: @backupTeam</div>
                                    <MudButton Class="mt-1" Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => StartEditBinding(b))">Edit</MudButton>
                                </MudListItem>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Class="mt-2 text-muted">No bindings yet.</MudText>
                        }
                    </MudList>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12">
            <MudCard>
                <MudCardContent>
                    <MudGrid GutterSize="2" Class="mb-3">
                        <MudItem xs="12" sm="6" md="4">
                            <MudSelect T="string" Label="Select customer" @bind-Value="selectedScheduleCustomerId" @bind-Value:after="OnScheduleCustomerChanged" Dense="true">
                                <MudSelectItem T="string" Disabled="true" Value="@string.Empty">Select</MudSelectItem>
                                @foreach (var c in customers)
                                {
                                    <MudSelectItem T="string" Value="@c.Id">@(!string.IsNullOrWhiteSpace(c.Name) ? c.Name : c.Id)</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4" Class="d-flex align-items-end gap-2">
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Disabled="@string.IsNullOrWhiteSpace(selectedScheduleCustomerId)" OnClick="LoadScheduleAsync">Refresh</MudButton>
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Disabled="@string.IsNullOrWhiteSpace(selectedScheduleCustomerId)" OnClick="RegenerateScheduleAsync">Regenerate</MudButton>
                        </MudItem>
                    </MudGrid>

                    @if (string.IsNullOrWhiteSpace(selectedScheduleCustomerId))
                    {
                        <MudText Typo="Typo.caption" Class="text-muted">Select a customer to view current and upcoming on-call coverage.</MudText>
                    }
                    else if (isLoadingSchedule)
                    {
                        <MudText Typo="Typo.caption" Class="text-muted">Loading schedule...</MudText>
                    }
                    else
                    {
                        <MudGrid GutterSize="2">
                            <MudItem xs="12" lg="4">
                                <MudPaper Class="pa-3">
                                    <MudText Typo="Typo.subtitle2" Class="mb-2">Current coverage</MudText>
                                    @if (currentCoverage.HasCoverage)
                                    {
                                        @if (currentCoverage.PrimarySlice is not null)
                                        {
                                            <div class="mb-2">
                                                <MudChip T="string" Color="@(currentCoverage.PrimarySlice.Role == "OnHours" ? Color.Primary : Color.Secondary)"
                                                         Variant="Variant.Filled" Size="Size.Small" Class="mb-1">@currentCoverage.PrimarySlice.Role</MudChip>
                                                <MudText Typo="Typo.caption">Team: @ResolveTeamName(currentCoverage.PrimarySlice.TeamId)</MudText>
                                                <MudText Typo="Typo.caption">Members: @FormatMembers(currentCoverage.PrimarySlice.MemberIds)</MudText>
                                                <MudText Typo="Typo.caption">Until @TimeZoneInfo.ConvertTimeFromUtc(currentCoverage.PrimarySlice.EndUtc, displayTimeZone).ToString("yyyy-MM-dd HH:mm")</MudText>
                                            </div>
                                        }
                                        @if (currentCoverage.BackupSlice is not null)
                                        {
                                            <div>
                                                <MudChip T="string" Style="background-color:#f6c344;color:#000;" Variant="Variant.Filled" Size="Size.Small" Class="mb-1">Backup</MudChip>
                                                <MudText Typo="Typo.caption">Team: @ResolveTeamName(currentCoverage.BackupSlice.TeamId)</MudText>
                                                <MudText Typo="Typo.caption">Members: @FormatMembers(currentCoverage.BackupSlice.MemberIds)</MudText>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.caption" Class="text-muted">No active coverage</MudText>
                                    }
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" lg="8">
                                <div class="d-flex flex-column gap-3">
                                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                                        <div class="d-flex align-items-center gap-3">
                                            <MudText Typo="Typo.subtitle2">Daily timeline (@displayTimeZoneId)</MudText>
                                            <div class="d-flex align-items-center gap-2 small">
                                                <MudChip T="string" Style="@($"background-color:{RoleColor.On};color:#fff;")" Variant="Variant.Filled" Size="Size.Small">On</MudChip>
                                                <MudChip T="string" Style="@($"background-color:{RoleColor.Off};color:#fff;")" Variant="Variant.Filled" Size="Size.Small">Off</MudChip>
                                                <MudChip T="string" Style="@($"background-color:{RoleColor.Backup};color:#000;")" Variant="Variant.Filled" Size="Size.Small">Backup</MudChip>
                                            </div>
                                        </div>
                                        <MudText Typo="Typo.caption" Class="text-muted">Ticks: 00 | 06 | 12 | 18 | 24 - @scheduleSlices.Count slice(s)</MudText>
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(scheduleInfo))
                                    {
                                        <MudAlert Severity="Severity.Info" Dense="true">@scheduleInfo</MudAlert>
                                    }
                                    <div class="px-2">
                                        <div class="d-flex text-muted small justify-content-between" style="padding-left: 120px;">
                                            <span>00</span><span>06</span><span>12</span><span>18</span><span>24</span>
                                        </div>
                                    </div>
                                    <div class="d-flex flex-column gap-2">
                                        @foreach (var day in scheduleDays)
                                        {
                                            <div class="d-flex align-items-center gap-3">
                                                <div style="width: 120px; min-width: 120px;">
                                                    <MudText Typo="Typo.subtitle2">@day.Date.ToString("ddd, MMM dd")</MudText>
                                                    @if (day.Date == DateOnly.FromDateTime(TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, displayTimeZone).Date))
                                                    {
                                                        <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Small">Today</MudChip>
                                                    }
                                                </div>
                                                <MudPaper Class="flex-grow-1 position-relative px-2 py-2" Style="min-height:60px; min-width:0; background-size:25% 100%; background-image: linear-gradient(to right, rgba(0,0,0,0.06) 1px, transparent 1px);">
                                                    <div class="position-relative" style="height: 54px; overflow: visible;">
                                                        @foreach (var slice in day.Slices.OrderBy(s => RoleRank(s.Role)).ThenBy(s => s.StartLocal))
                                                        {
                                                            <MudTooltip Text="@($"{slice.Role}: {ResolveTeamName(slice.TeamId)} {FormatSliceRange(slice)}")">
                                                                <MudPaper Class="position-absolute rounded-pill shadow-sm"
                                                                          Style="@($"{GetTimelineStyle(slice, day.Date)}height:14px; min-width:12px; background-color:{RoleColor.For(slice.Role)}; opacity:0.95; border:1px solid rgba(0,0,0,0.08);")"
                                                                          Elevation="1">
                                                                    <div class="d-flex align-items-center justify-content-center text-truncate"
                                                                         style="font-size:11px; line-height:14px; padding:0 4px; color:@RoleTextColor(slice.Role);">
                                                                        @FormatSliceInitials(slice)
                                                                    </div>
                                                                </MudPaper>
                                                            </MudTooltip>
                                                        }
                                                    </div>
                                                    @if (!day.Slices.Any())
                                                    {
                                                        <MudText Typo="Typo.caption" Class="text-muted">No coverage</MudText>
                                                    }
                                                </MudPaper>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </MudItem>
                        </MudGrid>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
}

@code {
    // Data from service
    private IReadOnlyList<OnCallPlan> plans = Array.Empty<OnCallPlan>();
    private IReadOnlyList<OnCallTeam> teams = Array.Empty<OnCallTeam>();
    private IReadOnlyList<CustomerPlanBinding> bindings = Array.Empty<CustomerPlanBinding>();
    private IReadOnlyList<Customer> customers = Array.Empty<Customer>();
    private IReadOnlyList<User> availableUsers = Array.Empty<User>();

    // Form state
    private PlanInput newPlan = new();
    private TeamInput newTeam = new();
    private BindingInput newBinding = new();

    private OnCallPlan? editingPlan;
    private OnCallTeam? editingTeam;
    private CustomerPlanBinding? editingBinding;

    // UI state
    private bool isLoading = true;
    private bool isSaving;
    private bool isLoadingSchedule;

    // Schedule view state
    private string selectedScheduleCustomerId = string.Empty;
    private CurrentCoverage currentCoverage = new(null, null);
    private IReadOnlyList<ScheduleSlice> scheduleSlices = Array.Empty<ScheduleSlice>();
    private List<ScheduleSliceView> localizedSlices = new();
    private List<ScheduleDayView> scheduleDays = new();

    private const int ScheduleViewHorizonDays = 21;
    private const int ScheduleGenerationHorizonDays = 45;
    private string scheduleInfo = string.Empty;
    private TimeZoneInfo displayTimeZone = TimeZoneInfo.Utc;
    private string displayTimeZoneId = "UTC";

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        try
        {
            var data = await ScheduleService.GetOnCallDataAsync();
            plans = data.Plans;
            teams = data.Teams;
            bindings = data.Bindings;
            customers = data.Customers;
            availableUsers = data.Users;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load on-call data");
            Snackbar.Add($"Failed to load on-call data: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SavePlanAsync()
    {
        if (isSaving) return;

        if (!TryParseTime(newPlan.Start, out var start) || !TryParseTime(newPlan.End, out var end))
        {
            Snackbar.Add("Provide valid on-hours start and end times", Severity.Warning);
            return;
        }

        isSaving = true;
        try
        {
            var plan = new OnCallPlan
            {
                Id = editingPlan?.Id ?? string.Empty,
                Name = newPlan.Name.Trim(),
                TimeZone = string.IsNullOrWhiteSpace(newPlan.TimeZone) ? "UTC" : newPlan.TimeZone.Trim(),
                OnHours = BuildOnHours(start, end, newPlan.IncludeWeekends),
                IncludeWeekends = newPlan.IncludeWeekends,
                Holidays = ParseHolidays(newPlan.Holidays),
                Escalation = editingPlan?.Escalation ?? new EscalationPolicy(),
                Rotation = editingPlan?.Rotation ?? new RotationDefaults(),
                Overrides = editingPlan?.Overrides ?? Array.Empty<PlanOverride>(),
                Version = editingPlan?.Version ?? "v1"
            };

            var saved = await ScheduleService.SavePlanAsync(plan);
            plans = plans.Where(p => p.Id != saved.Id).Append(saved).OrderBy(p => p.Name).ToList();

            editingPlan = null;
            ResetPlanForm();
            Snackbar.Add("Plan saved", Severity.Success);
        }
        catch (ArgumentException ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save plan");
            Snackbar.Add($"Failed to save plan: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void StartEditPlan(OnCallPlan plan)
    {
        editingPlan = plan;
        var firstWindow = plan.OnHours.FirstOrDefault();
        newPlan = new PlanInput
        {
            Name = plan.Name,
            TimeZone = plan.TimeZone,
            Start = firstWindow != null ? firstWindow.Start.ToString(@"hh\:mm", CultureInfo.InvariantCulture) : "08:00",
            End = firstWindow != null ? firstWindow.End.ToString(@"hh\:mm", CultureInfo.InvariantCulture) : "17:00",
            IncludeWeekends = plan.IncludeWeekends,
            Holidays = string.Join(',', plan.Holidays.OrderBy(h => h).Select(h => h.ToString("yyyy-MM-dd")))
        };
    }

    private void CancelPlanEdit()
    {
        editingPlan = null;
        ResetPlanForm();
    }

    private void ResetPlanForm() => newPlan = new PlanInput();

    private async Task SaveTeamAsync()
    {
        if (isSaving) return;

        var memberIds = new HashSet<string>(newTeam.SelectedUserIds, StringComparer.OrdinalIgnoreCase);
        if (!string.IsNullOrWhiteSpace(newTeam.ManualMembers))
        {
            foreach (var id in newTeam.ManualMembers.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
            {
                memberIds.Add(id);
            }
        }

        if (!memberIds.Any())
        {
            Snackbar.Add("Add at least one team member", Severity.Warning);
            return;
        }

        isSaving = true;
        try
        {
            var members = memberIds.Select((id, idx) => new TeamMember(id, true, idx)).ToList();
            var team = new OnCallTeam
            {
                Id = editingTeam?.Id ?? string.Empty,
                Name = newTeam.Name.Trim(),
                Enabled = true,
                ModeOverride = newTeam.WholeTeam ? RotationMode.WholeTeam : null,
                CadenceOverride = editingTeam?.CadenceOverride,
                RotationIntervalDays = newTeam.RotationIntervalDays,
                Members = members
            };

            var saved = await ScheduleService.SaveTeamAsync(team);
            teams = teams.Where(t => t.Id != saved.Id).Append(saved).OrderBy(t => t.Name).ToList();

            editingTeam = null;
            ResetTeamForm();
            Snackbar.Add("Team saved", Severity.Success);
        }
        catch (ArgumentException ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save team");
            Snackbar.Add($"Failed to save team: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void StartEditTeam(OnCallTeam team)
    {
        editingTeam = team;
        var memberIds = team.Members.Select(m => m.UserId).ToList();
        var knownIds = memberIds.Where(id => availableUsers.Any(u => u.Id.Equals(id, StringComparison.OrdinalIgnoreCase))).ToHashSet(StringComparer.OrdinalIgnoreCase);
        var manualIds = memberIds.Where(id => !knownIds.Contains(id));

        newTeam = new TeamInput
        {
            Name = team.Name,
            SelectedUserIds = knownIds,
            ManualMembers = string.Join(',', manualIds),
            WholeTeam = (team.ModeOverride ?? RotationMode.RollingIndividual) == RotationMode.WholeTeam,
            RotationIntervalDays = team.RotationIntervalDays
        };
    }

    private void CancelTeamEdit()
    {
        editingTeam = null;
        ResetTeamForm();
    }

    private void ResetTeamForm() => newTeam = new TeamInput();

    private Task OnUserSelectionChanged(IEnumerable<string> values)
    {
        newTeam.SelectedUserIds = values != null
            ? new HashSet<string>(values, StringComparer.OrdinalIgnoreCase)
            : new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        return Task.CompletedTask;
    }

    private async Task SaveBindingAsync()
    {
        if (isSaving) return;

        isSaving = true;
        try
        {
            var binding = new CustomerPlanBinding
            {
                Id = editingBinding?.Id ?? string.Empty,
                CustomerId = newBinding.CustomerId,
                PlanDefinitionId = newBinding.PlanId,
                OnHoursTeamId = newBinding.OnTeamId,
                OffHoursTeamId = newBinding.OffTeamId,
                BackupTeamId = newBinding.BackupTeamId,
                EffectiveFrom = newBinding.EffectiveFrom,
                EffectiveThrough = editingBinding?.EffectiveThrough,
                CustomerOverrides = editingBinding?.CustomerOverrides ?? Array.Empty<PlanOverride>()
            };

            var saved = await ScheduleService.SaveBindingAsync(binding);
            bindings = bindings.Where(b => b.CustomerId != saved.CustomerId).Append(saved).OrderBy(b => b.CustomerId).ToList();

            editingBinding = null;
            selectedScheduleCustomerId = saved.CustomerId;
            ResetBindingForm();
            Snackbar.Add("Binding saved", Severity.Success);

            // Regenerate schedule for the customer
            var fromUtc = DateTime.UtcNow.Date;
            var toUtc = fromUtc.AddDays(ScheduleGenerationHorizonDays);
            await ScheduleService.RegenerateAsync(saved.CustomerId, fromUtc, toUtc);
            await LoadScheduleAsync();
        }
        catch (ArgumentException ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save binding");
            Snackbar.Add($"Failed to save binding: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void StartEditBinding(CustomerPlanBinding binding)
    {
        editingBinding = binding;
        newBinding = new BindingInput
        {
            CustomerId = binding.CustomerId,
            PlanId = binding.PlanDefinitionId,
            OnTeamId = binding.OnHoursTeamId,
            OffTeamId = binding.OffHoursTeamId,
            BackupTeamId = binding.BackupTeamId,
            EffectiveFrom = binding.EffectiveFrom
        };

        selectedScheduleCustomerId = binding.CustomerId;
        _ = LoadScheduleAsync();
    }

    private void CancelBindingEdit()
    {
        editingBinding = null;
        ResetBindingForm();
    }

    private void ResetBindingForm()
    {
        newBinding = new BindingInput
        {
            EffectiveFrom = DateOnly.FromDateTime(DateTime.UtcNow.Date)
        };
    }

    private async Task LoadScheduleAsync()
    {
        if (string.IsNullOrWhiteSpace(selectedScheduleCustomerId))
        {
            currentCoverage = new(null, null);
            return;
        }

        isLoadingSchedule = true;
        try
        {
            var nowUtc = DateTime.UtcNow;
            var fromUtc = nowUtc.Date;
            var toUtc = nowUtc.Date.AddDays(ScheduleViewHorizonDays + 1);

            var result = await ScheduleService.GetScheduleAsync(selectedScheduleCustomerId, fromUtc, toUtc);

            scheduleSlices = result.Slices;
            currentCoverage = result.CurrentCoverage;
            displayTimeZone = result.DisplayTimeZone;
            displayTimeZoneId = result.DisplayTimeZoneId;

            BuildScheduleDays(nowUtc);

            if (!scheduleSlices.Any())
            {
                scheduleInfo = "No schedule slices found for this customer. Try Regenerate and verify plan/team binding.";
            }
            else
            {
                scheduleInfo = $"Window {fromUtc:yyyy-MM-dd} to {toUtc:yyyy-MM-dd} ({displayTimeZoneId}). Slices: {scheduleSlices.Count}, days with coverage: {scheduleDays.Count(d => d.Slices.Any())}/{scheduleDays.Count}.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load schedule slices for {CustomerId}", selectedScheduleCustomerId);
            Snackbar.Add($"Failed to load schedule: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoadingSchedule = false;
        }
    }

    private async Task RegenerateScheduleAsync()
    {
        if (string.IsNullOrWhiteSpace(selectedScheduleCustomerId)) return;

        isLoadingSchedule = true;
        try
        {
            var fromUtc = DateTime.UtcNow.Date;
            var toUtc = fromUtc.AddDays(ScheduleGenerationHorizonDays);
            await ScheduleService.RegenerateAsync(selectedScheduleCustomerId, fromUtc, toUtc);
            Snackbar.Add("Schedule regenerated", Severity.Success);
            await LoadScheduleAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to regenerate schedule");
            Snackbar.Add($"Failed to regenerate: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoadingSchedule = false;
        }
    }

    private Task OnScheduleCustomerChanged() => LoadScheduleAsync();

    // Helper methods for building models
    private static IReadOnlyList<DailyWindow> BuildOnHours(TimeSpan start, TimeSpan end, bool includeWeekends)
    {
        var days = Enum.GetValues<DayOfWeek>().Where(d => includeWeekends || (d != DayOfWeek.Saturday && d != DayOfWeek.Sunday));
        return days.Select(d => new DailyWindow(d, start, end)).ToList();
    }

    private static IReadOnlyList<DateOnly> ParseHolidays(string holidays)
    {
        if (string.IsNullOrWhiteSpace(holidays)) return Array.Empty<DateOnly>();

        var result = new List<DateOnly>();
        foreach (var value in holidays.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
        {
            if (DateOnly.TryParse(value, out var date))
            {
                result.Add(date);
            }
        }
        return result;
    }

    private static bool TryParseTime(string value, out TimeSpan time)
    {
        return TimeSpan.TryParseExact(value, new[] { "hh\\:mm", "h\\:mm" }, CultureInfo.InvariantCulture, out time);
    }

    // Display helpers
    private string FormatOnHours(OnCallPlan plan)
    {
        var window = plan.OnHours.FirstOrDefault();
        if (window == null) return "-";
        var span = $"{window.Start:hh\\:mm}-{window.End:hh\\:mm}";
        return plan.IncludeWeekends ? $"{span} (all days)" : $"{span} (weekdays)";
    }

    private string ResolveTeamName(string? id)
    {
        if (string.IsNullOrWhiteSpace(id)) return "-";
        return teams.FirstOrDefault(t => t.Id == id)?.Name ?? id;
    }

    private string ResolveUserDisplayName(string? userId)
    {
        if (string.IsNullOrWhiteSpace(userId)) return string.Empty;
        var user = availableUsers.FirstOrDefault(u => u.Id.Equals(userId, StringComparison.OrdinalIgnoreCase));
        if (user is null) return userId;
        return string.IsNullOrWhiteSpace(user.UserPrincipalName) ? user.DisplayName : $"{user.DisplayName} ({user.UserPrincipalName})";
    }

    private string GetInitials(string? userId)
    {
        if (string.IsNullOrWhiteSpace(userId)) return string.Empty;
        var user = availableUsers.FirstOrDefault(u => u.Id.Equals(userId, StringComparison.OrdinalIgnoreCase));
        var name = user?.DisplayName ?? userId;
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 0) return name.Length >= 2 ? name[..2].ToUpperInvariant() : name.ToUpperInvariant();
        if (parts.Length == 1) return parts[0].Length >= 2 ? parts[0][..2].ToUpperInvariant() : parts[0].ToUpperInvariant();
        return $"{parts[0][0]}{parts[^1][0]}".ToUpperInvariant();
    }

    private string GetTeamInitials(string? teamId)
    {
        if (string.IsNullOrWhiteSpace(teamId)) return string.Empty;
        var name = teams.FirstOrDefault(t => t.Id == teamId)?.Name ?? teamId;
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 0) return name.Length >= 2 ? name[..2].ToUpperInvariant() : name.ToUpperInvariant();
        if (parts.Length == 1) return parts[0].Length >= 2 ? parts[0][..2].ToUpperInvariant() : parts[0].ToUpperInvariant();
        return $"{parts[0][0]}{parts[^1][0]}".ToUpperInvariant();
    }

    private string FormatSliceInitials(ScheduleSliceView slice)
    {
        var memberIds = slice.MemberIds ?? Array.Empty<string>();
        var initials = memberIds.Select(GetInitials).Where(i => !string.IsNullOrWhiteSpace(i)).Take(3).ToList();
        if (initials.Count == 0) return GetTeamInitials(slice.TeamId);
        return string.Join("Â·", initials);
    }

    private string FormatMembers(IEnumerable<string> memberIds)
    {
        if (memberIds == null) return "-";
        var names = memberIds.Select(ResolveUserDisplayName).Where(n => !string.IsNullOrWhiteSpace(n)).ToList();
        return names.Any() ? string.Join(", ", names) : "-";
    }

    private DateTime? BindingEffectiveDate
    {
        get => newBinding.EffectiveFrom.ToDateTime(TimeOnly.MinValue);
        set => newBinding.EffectiveFrom = value.HasValue ? DateOnly.FromDateTime(value.Value.Date) : DateOnly.FromDateTime(DateTime.UtcNow.Date);
    }

    // Schedule visualization
    private void BuildScheduleDays(DateTime nowUtc)
    {
        localizedSlices = scheduleSlices
            .Select(s => new ScheduleSliceView(
                s,
                TimeZoneInfo.ConvertTimeFromUtc(s.StartUtc, displayTimeZone),
                TimeZoneInfo.ConvertTimeFromUtc(s.EndUtc, displayTimeZone)))
            .OrderBy(v => v.StartLocal)
            .ToList();

        var localNow = TimeZoneInfo.ConvertTimeFromUtc(nowUtc, displayTimeZone);
        var startDate = DateOnly.FromDateTime(localNow.Date);
        var days = new List<ScheduleDayView>();
        for (var i = 0; i < ScheduleViewHorizonDays; i++)
        {
            var date = startDate.AddDays(i);
            var dayStart = date.ToDateTime(TimeOnly.MinValue);
            var dayEnd = dayStart.AddDays(1);

            var slices = localizedSlices
                .Where(s => s.StartLocal < dayEnd && s.EndLocal > dayStart)
                .OrderBy(s => s.StartLocal)
                .ToList();

            days.Add(new ScheduleDayView { Date = date, Slices = slices });
        }
        scheduleDays = days;
    }

    private static int RoleRank(string role) => role switch
    {
        "OnHours" => 0,
        "OffHours" => 1,
        "Backup" => 2,
        _ => 3
    };

    private static class RoleColor
    {
        public const string On = "#0d6efd";
        public const string Off = "#6c757d";
        public const string Backup = "#f6c344";

        public static string For(string role) => role switch
        {
            "OnHours" => On,
            "OffHours" => Off,
            "Backup" => Backup,
            _ => "#adb5bd"
        };
    }

    private static string RoleTextColor(string role) => role switch
    {
        "Backup" => "#000",
        _ => "#fff"
    };

    private static int RoleOffset(string role) => role switch
    {
        "OnHours" => 4,
        "OffHours" => 20,
        "Backup" => 36,
        _ => 4
    };

    private static string FormatSliceRange(ScheduleSliceView slice) =>
        $"{slice.StartLocal:yyyy-MM-dd HH:mm}-{slice.EndLocal:HH:mm}";

    private static string GetTimelineStyle(ScheduleSliceView slice, DateOnly date)
    {
        var dayStart = date.ToDateTime(TimeOnly.MinValue);
        var dayEnd = dayStart.AddDays(1);
        var start = slice.StartLocal;
        var end = slice.EndLocal;

        if (end <= dayStart || start >= dayEnd) return "left:0;width:0;";

        var startMinutes = Math.Max(0, (start - dayStart).TotalMinutes);
        var endMinutes = Math.Min(1440, (end - dayStart).TotalMinutes);
        var widthMinutes = Math.Max(2, endMinutes - startMinutes);

        var leftPct = startMinutes / 1440d * 100d;
        var widthPct = widthMinutes / 1440d * 100d;

        var top = RoleOffset(slice.Role);
        return string.Format(
            CultureInfo.InvariantCulture,
            "left:{0:F2}%;width:{1:F2}%;min-width:12px;max-width:100%;top:{2}px;",
            leftPct,
            widthPct,
            top);
    }

    // Input classes
    private class PlanInput
    {
        public string Name { get; set; } = string.Empty;
        public string TimeZone { get; set; } = "UTC";
        public string Start { get; set; } = "08:00";
        public string End { get; set; } = "17:00";
        public bool IncludeWeekends { get; set; }
        public string Holidays { get; set; } = string.Empty;
    }

    private class TeamInput
    {
        public string Name { get; set; } = string.Empty;
        public HashSet<string> SelectedUserIds { get; set; } = new(StringComparer.OrdinalIgnoreCase);
        public string ManualMembers { get; set; } = string.Empty;
        public bool WholeTeam { get; set; }
        public int? RotationIntervalDays { get; set; }
    }

    private class BindingInput
    {
        public string CustomerId { get; set; } = string.Empty;
        public string PlanId { get; set; } = string.Empty;
        public string OnTeamId { get; set; } = string.Empty;
        public string OffTeamId { get; set; } = string.Empty;
        public string BackupTeamId { get; set; } = string.Empty;
        public DateOnly EffectiveFrom { get; set; } = DateOnly.FromDateTime(DateTime.UtcNow.Date);
    }

    private class ScheduleDayView
    {
        public DateOnly Date { get; set; }
        public List<ScheduleSliceView> Slices { get; set; } = new();
    }

    private record ScheduleSliceView(ScheduleSlice Slice, DateTime StartLocal, DateTime EndLocal)
    {
        public string Role => Slice.Role;
        public string TeamId => Slice.TeamId;
        public IReadOnlyList<string> MemberIds => Slice.MemberIds;
    }
}
