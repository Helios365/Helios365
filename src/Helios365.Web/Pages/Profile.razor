@page "/profile"
@attribute [Authorize(Policy = "ReaderOrAbove")]
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@using Helios365.Core.Models
@inject AuthenticationStateProvider AuthStateProvider
@inject IProfileService ProfileService
@inject ILogger<Profile> Logger

<PageTitle>Profile</PageTitle>

<MudGrid GutterSize="3">
    <MudItem xs="12" lg="6">
        <MudCard>
            <MudCardHeader>
                <div class="d-flex justify-content-between align-items-center w-100">
                    <MudText Typo="Typo.h6">Contact Information</MudText>
                    <MudButton OnClick="OpenEditModal" 
                               Color="Color.Primary" 
                               Variant="Variant.Text"
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.Edit">
                        Edit
                    </MudButton>
                </div>
            </MudCardHeader>
            <MudCardContent>
                @if (isLoading)
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                }
                else if (currentProfile == null || string.IsNullOrWhiteSpace(currentProfile.Mail))
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">No contact information set.</MudText>
                }
                else
                {
                    <MudStack Spacing="2">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Email</MudText>
                            <MudText Typo="Typo.body2">@currentProfile.Mail</MudText>
                        </div>
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Mobile Phone</MudText>
                            <MudText Typo="Typo.body2">@(currentProfile.MobilePhone ?? "-")</MudText>
                        </div>
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Policies Accepted</MudText>
                            <MudChip T="string" 
                                     Size="Size.Small" 
                                     Color="@(currentProfile.PoliciesAccepted ? Color.Success : Color.Default)">
                                @(currentProfile.PoliciesAccepted ? "Yes" : "No")
                            </MudChip>
                        </div>
                    </MudStack>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="12" lg="6">
        <MudCard>
            <MudCardHeader>
                <div class="d-flex align-items-center justify-content-between w-100">
                    <MudText Typo="Typo.h6">Roles</MudText>
                    <MudChip T="string" Variant="Variant.Outlined">@Roles.Count</MudChip>
                </div>
            </MudCardHeader>
            <MudCardContent>
                @if (Roles.Count == 0)
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary">No roles in the current token.</MudText>
                }
                else
                {
                    <MudList T="string" Dense="true">
                        @foreach (var role in Roles)
                        {
                            <MudListItem T="string">
                                <MudIcon Icon="@Icons.Material.Filled.Security" Color="Color.Success" Class="me-2" />
                                <MudText Typo="Typo.body2" Class="fw-semibold">@role</MudText>
                            </MudListItem>
                        }
                    </MudList>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@if (showEditModal)
{
    <ProfileCompletionModal ForceShow="true" OnClosed="HandleModalClosed" />
}

@code {
    private List<string> Roles { get; set; } = new();

    private User? currentProfile;
    private bool isLoading = true;
    private bool showEditModal;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        Roles = user.Claims
            .Where(c => c.Type == ClaimTypes.Role || c.Type == "roles")
            .Select(c => c.Value)
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(r => r)
            .ToList();

        await LoadProfileAsync();
    }

    private async Task LoadProfileAsync()
    {
        isLoading = true;
        try
        {
            currentProfile = await ProfileService.GetCurrentAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load profile");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenEditModal()
    {
        showEditModal = true;
    }
    
    private async Task HandleModalClosed()
    {
        showEditModal = false;
        await LoadProfileAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && showEditModal)
        {
            await Task.Delay(100);
            await LoadProfileAsync();
        }
    }
}
