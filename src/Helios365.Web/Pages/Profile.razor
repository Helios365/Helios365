@page "/profile"
@attribute [Authorize(Policy = "ReaderOrAbove")]
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@using Helios365.Core.Models
@inject AuthenticationStateProvider AuthStateProvider
@inject IProfileService ProfileService
@inject ILogger<Profile> Logger

<PageTitle>Profile</PageTitle>

<MudGrid GutterSize="3">
    <MudItem xs="12" lg="6">
        <MudCard>
            <MudCardHeader>
                <MudText Typo="Typo.h6">Profile</MudText>
            </MudCardHeader>
            <MudCardContent>
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2">@UserName</MudText>
                    <MudText Typo="Typo.body2"><strong>User principal:</strong> @PreferredUsername</MudText>
                    <MudText Typo="Typo.body2"><strong>Tenant:</strong> <code>@TenantId</code></MudText>
                    <MudText Typo="Typo.body2"><strong>Object ID:</strong> <code>@ObjectId</code></MudText>
                </MudStack>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="12" lg="6">
        <MudCard>
            <MudCardHeader>
                <div class="d-flex justify-content-between align-items-center w-100">
                    <MudText Typo="Typo.h6">Contact</MudText>
                    @if (!string.IsNullOrWhiteSpace(saveStatus))
                    {
                        <MudChip T="string" Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Small">@saveStatus</MudChip>
                    }
                </div>
            </MudCardHeader>
            <MudCardContent>
                <MudForm @ref="formRef" Model="contactForm" OnValidSubmit="SaveContactAsync">
                    <MudTextField T="string"
                                  For="@(() => contactForm.Mail)"
                                  @bind-Value="contactForm.Mail"
                                  Label="Email"
                                  Required="true"
                                  InputType="InputType.Email"
                                  Variant="Variant.Text"
                                  FullWidth="true"
                                  AutoComplete="email"
                                  Class="mb-3" />
                    <MudTextField T="string"
                                  For="@(() => contactForm.MobilePhone)"
                                  @bind-Value="contactForm.MobilePhone"
                                  Label="Mobile phone"
                                  Placeholder="+46701234567"
                                  Required="true"
                                  Variant="Variant.Text"
                                  FullWidth="true"
                                  AutoComplete="tel"
                                  Class="mb-3" />
                    <MudCheckBox T="bool"
                                 @bind-Checked="contactForm.NotificationConsentGranted"
                                 Label="I allow Helios365 to text or call this number for notifications."
                                 Class="mb-3" />
                    @if (!string.IsNullOrWhiteSpace(errorMessage))
                    {
                        <MudAlert Severity="Severity.Error" Dense="true" Class="mb-3">@errorMessage</MudAlert>
                    }
                    <div class="d-flex justify-content-end">
                        <MudButton OnClick="ValidateAndSave"
                                   Disabled="@isSaving"
                                   Color="Color.Primary"
                                   Variant="Variant.Filled">
                            @if (isSaving)
                            {
                                <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="me-2" />
                            }
                            Save contact info
                        </MudButton>
                    </div>
                </MudForm>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="12" lg="6">
        <MudCard>
            <MudCardHeader>
                <div class="d-flex align-items-center justify-content-between w-100">
                    <MudText Typo="Typo.h6">Roles</MudText>
                    <MudChip T="string" Variant="Variant.Outlined">@Roles.Count</MudChip>
                </div>
            </MudCardHeader>
            <MudCardContent>
                @if (Roles.Count == 0)
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary">No roles in the current token.</MudText>
                }
                else
                {
                    <MudList T="string" Dense="true">
                        @foreach (var role in Roles)
                        {
                            <MudListItem T="string">
                                <MudIcon Icon="@Icons.Material.Filled.Security" Color="Color.Success" Class="me-2" />
                                <MudText Typo="Typo.body2" Class="fw-semibold">@role</MudText>
                            </MudListItem>
                        }
                    </MudList>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private string UserName { get; set; } = string.Empty;
    private string PreferredUsername { get; set; } = string.Empty;
    private string TenantId { get; set; } = string.Empty;
    private string ObjectId { get; set; } = string.Empty;
    private List<string> Roles { get; set; } = new();

    private readonly ContactForm contactForm = new();
    private MudForm? formRef;
    private bool isSaving;
    private string saveStatus = string.Empty;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        UserName = user.Identity?.Name ?? string.Empty;
        PreferredUsername = user.FindFirstValue("preferred_username") ?? string.Empty;
        TenantId = user.FindFirstValue("http://schemas.microsoft.com/identity/claims/tenantid") ?? string.Empty;
        ObjectId = user.FindFirstValue("http://schemas.microsoft.com/identity/claims/objectidentifier") ?? string.Empty;

        Roles = user.Claims
            .Where(c => c.Type == ClaimTypes.Role || c.Type == "roles")
            .Select(c => c.Value)
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(r => r)
            .ToList();

        await LoadProfileAsync();
    }

    private async Task LoadProfileAsync()
    {
        errorMessage = string.Empty;
        saveStatus = string.Empty;
        try
        {
            var profile = await ProfileService.GetCurrentAsync();
            if (profile != null)
            {
                contactForm.Mail = profile.Mail ?? string.Empty;
                contactForm.MobilePhone = profile.MobilePhone ?? string.Empty;
                contactForm.NotificationConsentGranted = profile.NotificationConsentGranted;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load profile for editing");
            errorMessage = "Could not load your profile right now.";
        }
    }

    private async Task ValidateAndSave()
    {
        if (formRef == null || isSaving)
        {
            return;
        }

        errorMessage = string.Empty;
        saveStatus = string.Empty;
        contactForm.Mail = contactForm.Mail?.Trim() ?? string.Empty;
        contactForm.MobilePhone = contactForm.MobilePhone?.Trim() ?? string.Empty;

        await formRef.Validate();
        if (!formRef.IsValid)
        {
            return;
        }

        await SaveContactAsync();
    }

    private async Task SaveContactAsync()
    {
        if (isSaving)
        {
            return;
        }

        isSaving = true;
        try
        {
            var updated = await ProfileService.UpdateContactAsync(contactForm.Mail, contactForm.MobilePhone, contactForm.NotificationConsentGranted);
            contactForm.Mail = updated.Mail ?? contactForm.Mail;
            contactForm.MobilePhone = updated.MobilePhone ?? contactForm.MobilePhone;
            contactForm.NotificationConsentGranted = updated.NotificationConsentGranted;
            saveStatus = "Saved";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to update contact info");
            errorMessage = "Saving failed. Please try again.";
        }
        finally
        {
            isSaving = false;
        }
    }

    private class ContactForm
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Enter a valid email")]
        public string Mail { get; set; } = string.Empty;

        [Required(ErrorMessage = "Mobile phone is required")]
        [RegularExpression("^\\+[1-9][0-9]{7,14}$", ErrorMessage = "Use international format, e.g. +46701234567")]
        public string MobilePhone { get; set; } = string.Empty;

        [Range(typeof(bool), "true", "true", ErrorMessage = "Please allow Helios365 to text or call this number.")]
        public bool NotificationConsentGranted { get; set; }
    }
}
