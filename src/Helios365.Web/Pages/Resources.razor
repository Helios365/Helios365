@page "/resources"
@using Helios365.Core.Models
@using Helios365.Core.Repositories
@using Helios365.Core.Services
@using MudBlazor

<PageTitle>Resources</PageTitle>

<h1 class="mb-3">Resources</h1>
<p class="text-muted mb-4">Browse and synchronize resources discovered from Azure Resource Graph.</p>

@if (isLoading)
{
    <div class="text-center py-5">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" Class="mb-2" />
        <div class="text-muted">Loading resources...</div>
    </div>
}
else
{
    <MudGrid Class="mb-4">
        <MudItem xs="6" lg="3">
            <MudCard Elevation="1" Class="h-100">
                <MudCardContent Class="text-center">
                    <MudText Typo="Typo.h4" Color="Color.Primary">@resourceViews.Count</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Total resources</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="6" lg="3">
            <MudCard Elevation="1" Class="h-100">
                <MudCardContent Class="text-center">
                    <MudText Typo="Typo.h4">@resourceViews.Select(r => r.Resource.CustomerId).Distinct().Count()</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Customers covered</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <MudPaper Class="pa-4">
        <div class="d-flex flex-wrap gap-3 mb-3 align-items-center">
            <MudTextField T="string"
                          Value="@search"
                          ValueChanged="OnSearchChanged"
                          ValueExpression="() => search"
                          Placeholder="Search by name or type..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Class="flex-grow-1"
                          Immediate="true" />

            <MudSelect T="string"
                       Value="@selectedCustomer"
                       ValueChanged="OnCustomerChanged"
                       ValueExpression="() => selectedCustomer"
                       Placeholder="Customer"
                       Dense="true"
                       Class="resource-filter-select">
                <MudSelectItem Value="@string.Empty">All customers</MudSelectItem>
                @foreach (var option in customerFilterOptions)
                {
                    <MudSelectItem Value="@option.Key">@option.Value</MudSelectItem>
                }
            </MudSelect>

            <MudSelect T="string"
                       Value="@selectedServicePrincipal"
                       ValueChanged="OnServicePrincipalChanged"
                       ValueExpression="() => selectedServicePrincipal"
                       Placeholder="Service principal"
                       Dense="true"
                       Class="resource-filter-select">
                <MudSelectItem Value="@string.Empty">All service principals</MudSelectItem>
                @foreach (var option in servicePrincipalFilterOptions)
                {
                    <MudSelectItem Value="@option.Key">@option.Value</MudSelectItem>
                }
            </MudSelect>

            <MudSelect T="string"
                       Value="@selectedLocation"
                       ValueChanged="OnLocationChanged"
                       ValueExpression="() => selectedLocation"
                       Placeholder="Location"
                       Dense="true"
                       Class="resource-filter-select">
                <MudSelectItem Value="@string.Empty">All locations</MudSelectItem>
                @foreach (var location in locationFilterOptions)
                {
                    <MudSelectItem Value="@location">@location</MudSelectItem>
                }
            </MudSelect>

            <MudSelect T="string"
                       Value="@selectedResourceType"
                       ValueChanged="OnResourceTypeChanged"
                       ValueExpression="() => selectedResourceType"
                       Placeholder="Resource type"
                       Dense="true"
                       Class="resource-filter-select"
                       Style="min-width: 220px;">
                <MudSelectItem Value="@string.Empty">All types</MudSelectItem>
                @foreach (var rt in resourceTypeOptions)
                {
                    <MudSelectItem Value="@rt">@rt</MudSelectItem>
                }
            </MudSelect>

            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                           Color="Color.Primary"
                           Title="Reload"
                           Disabled="@isLoading"
                           OnClick="ReloadAsync" />

            <MudIconButton Icon="@Icons.Material.Filled.CloudSync"
                           Color="Color.Secondary"
                           Title="Re-sync from Azure Resource Graph"
                           Disabled="@syncing"
                           OnClick="SyncResourcesAsync" />
        </div>

        @if (!FilteredResources.Any())
        {
            <MudAlert Severity="Severity.Info">
                No resources match the current filters.
            </MudAlert>
        }
        else
        {
            <MudTable Items="FilteredResources"
                      Dense="true"
                      Hover="true"
                      Elevation="0"
                      Breakpoint="Breakpoint.Md"
                      OnRowClick="HandleRowClick"
                      T="ResourceViewModel"
                      RowStyle="cursor: pointer;"
                      RowsPerPage="@pageSize"
                      Bordered="false"
                      ServerData="LoadPageAsync"
                      @ref="table">
                <HeaderContent>
                    <MudTh class="text-center"><span class="visually-hidden">Type</span></MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Resource Group</MudTh>
                    <MudTh>Location</MudTh>
                    <MudTh>Type</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Type" Class="text-center">
                        <img src="@GetResourceImage(context.Resource.ResourceType)"
                             alt="Resource icon"
                             width="36"
                             height="36"
                             class="d-inline-block" />
                    </MudTd>
                    <MudTd DataLabel="Name">
                        <div class="fw-bold">@context.Resource.Name</div>
                    </MudTd>
                    <MudTd DataLabel="Resource Group">@context.ResourceGroup</MudTd>
                    <MudTd DataLabel="Location">@context.Location</MudTd>
                    <MudTd DataLabel="Type">@context.Resource.ResourceType</MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] {10, 20, 50}" />
                </PagerContent>
            </MudTable>
        }
    </MudPaper>
}
