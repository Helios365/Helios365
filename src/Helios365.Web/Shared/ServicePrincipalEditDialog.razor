@using Helios365.Core.Models
@using Helios365.Web.Models
@using MudBlazor
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="form" Model="editModel">
            <MudTextField @bind-Value="editModel.Name" Label="Name" For="() => editModel.Name" Required="true" />
            @if (!LockCustomerId)
            {
                <MudTextField @bind-Value="editModel.CustomerId" Label="Customer ID" For="() => editModel.CustomerId" Required="true" />
            }
            <MudTextField @bind-Value="editModel.TenantId" Label="Tenant ID" For="() => editModel.TenantId" Required="true" />
            <MudTextField @bind-Value="editModel.ClientId" Label="Client ID (App ID)" For="() => editModel.ClientId" Required="true" />
            
            @if (IsEdit)
            {
                <MudAlert Severity="@((HasSecret) ? Severity.Success : Severity.Warning)" Variant="Variant.Outlined" Class="mb-2">
                    Secret status: <strong>@(HasSecret ? "Set" : "Not set")</strong>
                </MudAlert>

                <MudSwitch @bind-Value="rotateSecret" Color="Color.Primary" Label="Set/Rotate Secret" Class="mb-2" />
                @if (rotateSecret)
                {
                    <MudTextField @bind-Value="newSecret" Label="New Client Secret (paste from Entra)" InputType="InputType.Password" For="() => newSecret" InputAttributes="passwordInputAttrs" />
                    <MudTextField @bind-Value="confirmSecret" Label="Confirm Secret" InputType="InputType.Password" For="() => confirmSecret" InputAttributes="passwordInputAttrs" />
                    @if (!string.IsNullOrWhiteSpace(secretError))
                    {
                        <MudAlert Severity="Severity.Error">@secretError</MudAlert>
                    }
                }
            }
            else
            {
                <MudTextField @bind-Value="newSecret" Label="Client Secret (paste from Entra)" InputType="InputType.Password" For="() => newSecret" Required="true" AutoFocus="true" InputAttributes="passwordInputAttrs" />
                <MudTextField @bind-Value="confirmSecret" Label="Confirm Secret" InputType="InputType.Password" For="() => confirmSecret" Required="true" InputAttributes="passwordInputAttrs" />
                @if (!string.IsNullOrWhiteSpace(secretError))
                {
                    <MudAlert Severity="Severity.Error">@secretError</MudAlert>
                }
            }
            <MudSelect T="AzureCloudEnvironment" @bind-Value="editModel.CloudEnvironment" Label="Cloud Environment" Required="true">
                @foreach (var value in Enum.GetValues<AzureCloudEnvironment>())
                {
                    <MudSelectItem Value="value">@value</MudSelectItem>
                }
            </MudSelect>
            <MudSwitch @bind-Value="editModel.Active" Color="Color.Primary" Label="Active" />
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save">Save</MudButton>
    </DialogActions>
    
</MudDialog>

@code {
    [CascadingParameter] MudBlazor.IMudDialogInstance? MudDialog { get; set; }

    [Parameter] public ServicePrincipal? Model { get; set; }
    [Parameter] public bool IsEdit { get; set; }
    [Parameter] public bool LockCustomerId { get; set; }

    private MudForm? form;
    private ServicePrincipal editModel = new();
    private bool rotateSecret;
    private string newSecret = string.Empty;
    private string confirmSecret = string.Empty;
    private string secretError = string.Empty;
    private bool HasSecret => !string.IsNullOrWhiteSpace(editModel.ClientSecretKeyVaultReference);
    private readonly Dictionary<string, object> passwordInputAttrs = new()
    {
        ["autocomplete"] = "new-password"
    };

    protected override void OnInitialized()
    {
        editModel = Model is null ? new ServicePrincipal() : new ServicePrincipal
        {
            Id = Model.Id,
            CustomerId = Model.CustomerId,
            Name = Model.Name,
            TenantId = Model.TenantId,
            ClientId = Model.ClientId,
            ClientSecretKeyVaultReference = Model.ClientSecretKeyVaultReference,
            CloudEnvironment = Model.CloudEnvironment,
            Active = Model.Active,
            CreatedAt = Model.CreatedAt,
            UpdatedAt = Model.UpdatedAt,
            Metadata = new Dictionary<string, string>(Model.Metadata)
        };

        if (!IsEdit)
        {
            if (string.IsNullOrWhiteSpace(editModel.Id)) editModel.Id = Guid.NewGuid().ToString("N");
            rotateSecret = true; // Require secret on create
        }
    }

    private async Task Save()
    {
        secretError = string.Empty;
        if (form is not null)
        {
            await form.Validate();
            if (!form.IsValid)
                return;
        }

        if (rotateSecret)
        {
            if (string.IsNullOrWhiteSpace(newSecret))
            {
                secretError = "Secret is required";
                StateHasChanged();
                return;
            }
            if (!string.Equals(newSecret, confirmSecret, StringComparison.Ordinal))
            {
                secretError = "Secrets do not match";
                StateHasChanged();
                return;
            }
        }

        var result = new ServicePrincipalEditResult
        {
            Principal = editModel,
            NewClientSecret = rotateSecret ? newSecret : null
        };
        MudDialog?.Close(DialogResult.Ok(result));
    }

    private void Cancel() => MudDialog?.Cancel();

    
}
